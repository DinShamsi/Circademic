<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circademic -  拽专</title>
    <link rel="icon" href="favicon2.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&family=Rubik:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Design System Variables */
        :root {
            --primary: #3B82F6; --primary-light: #60A5FA; --primary-dark: #2563EB;
            --secondary: #8B5CF6; --secondary-light: #A78BFA; --secondary-dark: #7C3AED;
            --accent: #F59E0B; --accent-light: #FBBF24; --accent-dark: #D97706;
            --success: #10B981; --success-light: #34D399; --success-dark: #059669;
            --bg-light: #F9FAFB; --bg-lighter: #FFFFFF; --bg-dark: #0F172A;
            --bg-darker: #030712; --bg-dark-card: #1E293B;
            --text-primary-light: #111827; --text-secondary-light: #6B7280;
            --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF;
            --border-light: #E5E7EB; --border-dark: #374151;
            --spacing-xs: 0.25rem; --spacing-sm: 0.5rem; --spacing-md: 1rem;
            --spacing-lg: 1.5rem; --spacing-xl: 2rem;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;
        }

        body { 
            font-family: 'Heebo', sans-serif;
            background: var(--bg-light);
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.dark { background: var(--bg-dark); }
        h1, h2, h3 { font-family: 'Rubik', sans-serif; font-weight: 700; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .sidebar { background: white; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; }
        .dark .sidebar { background: var(--bg-dark-card); box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; right: -100%; height: 100vh; width: 280px; }
            .sidebar.open { right: 0; }
        }
        .dashboard-card { background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeInUp 0.5s ease-out; }
        .dashboard-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1); border-color: rgba(59, 130, 246, 0.3); }
        .dark .dashboard-card { background: var(--bg-dark-card); border-color: rgba(59, 130, 246, 0.2); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .dark .dashboard-card:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4); }
        .action-button { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: var(--radius-md); padding: 1rem; text-decoration: none; display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; font-weight: 600; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }
        .action-button.secondary { background: linear-gradient(135deg, var(--accent), #EF4444); }
        .action-button.success { background: linear-gradient(135deg, var(--success), var(--success-dark)); }
        .action-button.info {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-dark));
        }
        .action-button.shield {
             background: linear-gradient(135deg, #22D3EE, #0EA5E9);
        }
        .action-button.shield:hover {
            box-shadow: 0 8px 20px rgba(34, 211, 238, 0.4);
        }

        .stat-number { background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .progress-bar-container { width: 100%; height: 0.75rem; background: var(--border-light); border-radius: 9999px; overflow: hidden; position: relative; }
        .dark .progress-bar-container { background: var(--bg-dark); }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 9999px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .announcement { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-right: 4px solid var(--primary); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; animation: fadeInUp 0.5s ease-out; }
        .dark .announcement { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: var(--radius-md); color: var(--text-secondary-light); text-decoration: none; transition: all 0.2s ease; cursor: pointer; }
        .nav-item:hover { background: rgba(59, 130, 246, 0.1); color: var(--primary); transform: translateX(-4px); }
        .nav-item.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); color: var(--primary); font-weight: 600; }
        .dark .nav-item { color: var(--text-secondary-dark); }
        .dark .nav-item:hover { background: rgba(59, 130, 246, 0.2); color: var(--primary-light); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4); }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 92, 246, 0.5); }
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .modal-container { background: white; border-radius: var(--radius-xl); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: fadeInUp 0.3s ease-out; }
        .dark .modal-container { background: var(--bg-dark-card); }
        .input-field { padding: 0.75rem 1rem; border: 2px solid var(--border-light); border-radius: var(--radius-md); background: var(--bg-light); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-size: 0.938rem; width: 100%; }
        .input-field:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .dark .input-field { background: var(--bg-darker); border-color: var(--border-dark); color: var(--text-primary-dark); }
        .dark .input-field:focus { background: var(--bg-dark); border-color: var(--primary-light); }
        .icon-btn { width: 2.75rem; height: 2.75rem; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; text-decoration: none; }
        .icon-btn:hover { background: rgba(59, 130, 246, 0.2); transform: scale(1.1); }
        .dark .icon-btn { background: rgba(59, 130, 246, 0.15); }
        .dark .icon-btn:hover { background: rgba(59, 130, 246, 0.25); }
        .mobile-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 35; }
        .mobile-overlay.active { display: block; }
        .loading { display: flex; align-items: center; justify-content: center; height: 100vh; animation: pulse 2s infinite; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .user-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge.new { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); }

        /* --- 住驻转 住转 拽专 住住专 --- */
        .semester-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem;
            background-color: rgba(59, 130, 246, 0.05);
            border-radius: var(--radius-md);
            transition: background-color 0.2s ease;
        }
        .semester-accordion-header:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .semester-accordion-header {
            background-color: rgba(59, 130, 246, 0.15);
        }
        .dark .semester-accordion-header:hover {
            background-color: rgba(59, 130, 246, 0.25);
        }
        .semester-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: var(--bg-light);
            border-bottom-left-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
        }
        .dark .semester-accordion-content {
            background: var(--bg-dark);
        }
        .semester-accordion-content.open {
            max-height: 500px; /* 注专  砖专专转 */
            padding: 0.75rem;
            border-top: 1px solid var(--border-light);
        }
        .dark .semester-accordion-content.open {
            border-top-color: var(--border-dark);
        }
        .semester-accordion-header .icon-toggle {
            transition: transform 0.3s ease;
            flex-shrink: 0;
            margin-right: 0.5rem;
        }
        .semester-accordion-header.open .icon-toggle {
            transform: rotate(180deg);
        }
        /* ------------------------------------- */
        
        /* 住 驻住 砖驻专 () */
        #print-report { display: none; font-family: 'Heebo', sans-serif !important; }
        @media print {
            body { background: white !important; color: black !important; }
            .sidebar, #mobile-menu-toggle, header.mb-8, .no-print { display: none !important; }
            main { padding: 10mm !important; width: 100% !important; }
            #print-report { display: block !important; }
            #print-header { display: flex !important; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; }
            #print-header img { width: 70px; height: 70px; }
            #print-header h1 { font-family: 'Rubik', sans-serif; font-size: 26px; font-weight: 700; color: var(--primary); margin: 0; }
            #print-header h2 { font-family: 'Rubik', sans-serif; font-size: 22px; font-weight: 700; color: #111827; margin-top: 1.5rem; }
            #print-header p { font-family: 'Heebo', sans-serif; font-size: 14px; margin-top: 0.5rem; color: #6B7280; }
            .print-card { border: 1px solid var(--border-light) !important; border-radius: var(--radius-lg) !important; padding: 1.5rem !important; page-break-inside: avoid !important; background: white !important; }
            .print-card h3 { font-family: 'Rubik', sans-serif; font-size: 16px; font-weight: 700; color: var(--primary); border-bottom: 1px solid var(--border-light); padding-bottom: 0.75rem; margin-bottom: 1rem; }
            .print-grid-container { display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 1.5rem !important; margin-top: 1.5rem !important; }
            .print-span-2 { grid-column: span 2 / span 2 !important; }
            .print-stat-value { font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 2.5rem; color: var(--primary-dark); line-height: 1; }
            .print-stat-label { font-size: 1rem; color: var(--text-secondary-light); margin-top: 0.25rem; }
            .print-progress-bar-container { width: 100%; height: 1.5rem; background: var(--border-light) !important; border-radius: 9999px; overflow: hidden; position: relative; }
            .print-progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)) !important; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; font-weight: 700; }
            .print-list { list-style-type: none; padding: 0; margin: 0; }
            .print-list li { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed var(--border-light); }
            .print-list li:last-child { border-bottom: none; }
            .print-list li .course-name { font-weight: 500; color: var(--text-primary-light); }
            .print-list li .course-grade { font-weight: 700; color: var(--primary-dark); }
            .print-list li .course-grade-low { color: var(--danger); }
            .chart-print-container { height: 300px; width: 100%; }
            .stat-number, .dark .stat-number, .dark .text-gray-200, .dark .text-gray-400, .text-gray-800, .text-gray-600, .text-gray-500, .text-gray-700, .text-green-500 { color: black !important; -webkit-text-fill-color: black !important; background: none !important; }
            .badge { background: #eee !important; color: black !important; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    
    <div id="loading-screen" class="loading">
        <div class="spinner"></div>
    </div>

    <div id="app" class="hidden">
        
        <button id="mobile-menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg">
            <i data-lucide="menu" class="w-5 h-5 text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="mobile-overlay" class="mobile-overlay"></div>

        <div class="flex min-h-screen">
            
            <aside id="sidebar" class="sidebar w-64 flex-shrink-0 md:relative md:translate-x-0">
                <div class="p-6 h-full flex flex-col">
                    
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-6">
                            <img src="LOGO.png" alt="Logo" class="w-12 h-12">
                            <h1 class="text-2xl font-bold stat-number">Circademic</h1>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="user-avatar" id="user-avatar">
                                    <span id="user-initial">?</span>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800 dark:text-gray-200" id="user-name">注...</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400" id="user-email">...</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="profile-settings" class="text-xs px-3 py-1 bg-white dark:bg-gray-700 rounded-lg hover:shadow-md transition-all">
                                    <i data-lucide="settings" class="w-3 h-3 inline ml-1"></i>
                                    专转
                                </button>
                                <button id="logout-btn" class="text-xs px-3 py-1 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 rounded-lg hover:shadow-md transition-all">
                                    <i data-lucide="log-out" class="w-3 h-3 inline ml-1"></i>
                                    爪
                                </button>
                            </div>
                        </div>
                    </div>

                    <nav class="flex-1">
                        <a href="#" class="nav-item active">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span> 拽专</span>
                        </a>
                        <a href="AcademicStatus.html" class="nav-item">
                            <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                            <span>转 拽专住</span>
                        </a>
                        <a href="#" class="nav-item" id="schedule-link">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span>注专转 砖注转</span>
                            <span class="badge new mr-auto">拽专</span>
                        </a>
                        <a href="#" class="nav-item" id="notes-link">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            <span>住 住转</span>
                            <span class="badge new mr-auto">拽专</span>
                        </a>
                        <a href="#" class="nav-item" id="tasks-link">
                            <i data-lucide="check-square" class="w-5 h-5"></i>
                            <span>砖转</span>
                            <span class="badge new mr-auto">拽专</span>
                        </a>
                        <hr class="my-4 border-gray-200 dark:border-gray-700">
                        <a href="contact.html" class="nav-item">
                            <i data-lucide="send" class="w-5 h-5"></i>
                            <span>爪专 拽砖专</span>
                        </a>
                        <a href="about.html" class="nav-item">
                            <i data-lucide="info" class="w-5 h-5"></i>
                            <span>转 注专转</span>
                        </a>
                    </nav>

                    <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="dark-mode-toggle" class="nav-item w-full">
                            <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                            <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                            <span>爪 </span>
                        </button>
                    </div>
                </div>
            </aside>
            <main class="flex-1 p-4 md:p-8 overflow-y-auto">
                
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                        砖 <span id="welcome-name">砖转砖</span>! 
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400"> 砖注 ?  专 转 转拽转 砖</p>
                </header>

                <div class="stats-grid mb-8 no-print">
                    <div class="dashboard-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-blue-100 to-blue-200 dark:from-blue-900 dark:to-blue-800 rounded-lg">
                                <i data-lucide="trending-up" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">爪注 </span>
                        </div>
                        <h3 class="text-3xl font-bold stat-number" id="avg-grade">0.00</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2" id="avg-goal-display">
                            注: <span id="target-average"> 专</span>
                        </p>
                    </div>
                    <div class="dashboard-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-purple-100 to-purple-200 dark:from-purple-900 dark:to-purple-800 rounded-lg">
                                <i data-lucide="book-open" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">拽转 转 (砖砖)</span>
                        </div>
                        <h3 class="text-3xl font-bold stat-number" id="total-credits">0</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            转 <span id="required-credits">120</span> 专砖
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 hidden" id="active-credits-display">
                             (<span id="active-credits-value" class="font-bold">0</span> 住住专 )
                        </p>
                    </div>
                    <div class="dashboard-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-green-100 to-green-200 dark:from-green-900 dark:to-green-800 rounded-lg">
                                <i data-lucide="layers" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">拽专住 驻注</span>
                        </div>
                        <h3 class="text-3xl font-bold stat-number" id="active-courses">0</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            住住专 
                        </p>
                    </div>
                    <div class="dashboard-card">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-gradient-to-r from-orange-100 to-orange-200 dark:from-orange-900 dark:to-orange-800 rounded-lg">
                                <i data-lucide="calendar-days" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                            </div>
                            <span class="text-sm text-gray-500 dark:text-gray-400">住住专 </span>
                        </div>
                        <h3 class="text-3xl font-bold stat-number" id="current-semester">1</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            砖 <span id="current-year">'</span>
                        </p>
                    </div>
                </div>

                <div class="dashboard-card mb-8 no-print">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">转拽转 转专</h3>
                        <span class="badge" id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar-container mb-4">
                        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">拽专住 </p>
                            <p class="font-bold text-lg stat-number" id="mandatory-progress">0/0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">拽专住 专</p>
                            <p class="font-bold text-lg stat-number" id="elective-progress">0/0</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">住住</p>
                            <p class="font-bold text-lg text-green-500" id="status">驻注</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">爪 砖</p>
                            <p class="font-bold text-lg stat-number truncate" id="highest-grade-stat">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">爪 </p>
                            <p class="font-bold text-lg text-red-500 dark:text-red-400 truncate" id="lowest-grade-stat">-</p>
                        </div>
                        </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 no-print">
                    
                    <div class="dashboard-card lg:col-span-1 no-print">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                            <i data-lucide="bell" class="inline w-5 h-5 ml-2"></i>
                            注转 注
                        </h3>
                        <div id="announcements-container">
                            <div class="announcement">
                                <p class="font-semibold text-gray-800 dark:text-gray-200 mb-1">
                                    专  -Circademic! 
                                </p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    注专转 砖 砖 注拽 拽. 转  转 拽专住 砖  专转 转  住住拽转 注转.
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">驻 2 砖注转</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card lg:col-span-1 no-print">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                            <i data-lucide="pie-chart" class="inline w-5 h-5 ml-2"></i>
                            爪注 住住专
                        </h3>
                        <div id="semester-averages-dashboard" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                            <p class="text-gray-400">注 转...</p>
                        </div>
                    </div>
                    <div class="dashboard-card no-print lg:col-span-1">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                            <i data-lucide="zap" class="inline w-5 h-5 ml-2"></i>
                            驻注转 专转
                        </h3>
                        <div class="grid grid-cols-1 gap-4">
                            <button id="add-active-courses-btn" class="action-button info">
                                <i data-lucide="plus-square" class="w-5 h-5"></i>
                                <span>专 转 住住专 </span>
                            </button>
                            <button id="print-report-btn" class="action-button success">
                                <i data-lucide="printer" class="w-5 h-5"></i>
                                <span>驻住  转拽转</span>
                            </button>
                            <button id="what-if-btn" class="action-button secondary">
                                <i data-lucide="calculator" class="w-5 h-5"></i>
                                <span>砖 " "</span>
                            </button>
                            <button id="shield-calculator-btn" class="action-button shield">
                                <i data-lucide="shield" class="w-5 h-5"></i>
                                <span>砖 </span>
                            </button>
                            <button id="set-goal-btn" class="action-button">
                                <i data-lucide="target" class="w-5 h-5"></i>
                                <span>专转 注 爪注</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8 no-print">
                    <div class="dashboard-card no-print">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                            <i data-lucide="line-chart" class="inline w-5 h-5 ml-2"></i>
                            转 爪 ()
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="grade-trend-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card no-print">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4">
                            <i data-lucide="target" class="inline w-5 h-5 ml-2"></i>
                            转驻转 注
                        </h3>
                        <div style="height: 300px;">
                            <canvas id="moed-chart-dashboard"></canvas>
                        </div>
                    </div>
                    </div>

            </main>
        </div>
    </div>
    
    <div id="print-report" class="hidden">
        <div id="print-header">
            <div>
                <h1 style="font-family: 'Rubik', sans-serif; font-size: 26px; font-weight: 700; color: #3B82F6;">Circademic</h1>
                <h2 style="font-family: 'Rubik', sans-serif; font-size: 22px; font-weight: 700; color: #111827; margin-top: 1rem;">
                     转拽转 拽
                </h2>
                <p id="print-student-name" style="font-family: 'Heebo', sans-serif; font-size: 14px; margin-top: 0.5rem; color: #6B7280;">
                    注 转 住...
                </p>
            </div>
            <img src="LOGO.png" alt="Logo" style="width: 70px; height: 70px;">
        </div>
        <div class="print-grid-container">
            <div class="print-card">
                <h3>爪注 砖拽</h3>
                <p class="print-stat-value" id="print-avg-grade">0.00</p>
                <p class="print-stat-label">住住 注 拽专住 注 爪</p>
            </div>
            <div class="print-card">
                <h3>住" 拽转 转</h3>
                <p class="print-stat-value">
                    <span id="print-total-credits">0</span> / <span id="print-required-credits">120</span>
                </p>
                <p class="print-stat-label">" 砖砖 转 住 " 转专</p>
            </div>
            <div class="print-card print-span-2">
                <h3>转拽转 转专</h3>
                <div class="print-progress-bar-container">
                    <div id="print-progress-bar" class="print-progress-bar" style="width: 0%;">
                        <span id="print-progress-percent">0%</span>
                    </div>
                </div>
            </div>
            <div class="print-card">
                <h3>爪 拽爪</h3>
                <ul class="print-list">
                    <li>
                        <span class="course-name">爪 </span>
                        <span id="print-highest-grade" class="course-grade" style="color: var(--success-dark);">-</span>
                    </li>
                    <li>
                        <span class="course-name">爪 </span>
                        <span id="print-lowest-grade" class="course-grade" style="color: var(--danger);">-</span>
                    </li>
                </ul>
            </div>
            <div class="print-card">
                <h3>爪注 住住专</h3>
                <ul id="print-semester-averages" class="print-list" style="max-height: 150px; overflow-y: auto;">
                    <li> 转</li>
                </ul>
            </div>
        </div>
        <div class="print-card" style="margin-top: 1.5rem;">
            <h3>转 爪</h3>
            <div class="chart-print-container">
                <canvas id="print-grade-trend-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="active-courses-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="modal-container p-6 max-w-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">专转 转 住住专 </h2>
                <button type="button" id="close-active-courses-modal" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <form id="active-semester-form" class="space-y-4">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                     转 转 注专 住住专  砖. 转  砖砖 转爪  砖专
                    <b> 砖驻注 注 砖 爪注  注 住 " 砖砖</b>.
                </p>
                
                <div>
                    <label for="active-courses-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        转 拽专住 住住专 
                    </label>
                    <input type="number" id="active-courses-input" min="0" placeholder=": 6" class="input-field">
                </div>
                
                <div>
                    <label for="active-credits-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        住" 拽转 转 住住专 
                    </label>
                    <input type="number" id="active-credits-input" step="0.5" min="0" placeholder=": 21.5" class="input-field">
                </div>

                <div class="flex gap-4 pt-6 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <button type="submit" class="btn-primary flex-1">砖专 转</button>
                    <button type="button" id="clear-active-semester-btn" class="btn-secondary flex-1" style="background: #6B7280;">拽 转</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4 z-50"> <div class="modal-container p-8 max-w-md w-full"> <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6">专转 驻专驻</h2> <form id="settings-form" class="space-y-4"> <div> <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">砖 </label> <input type="text" id="settings-name" class="input-field w-full"> </div> <div> <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">住 </label> <input type="text" id="settings-institution" class="input-field w-full"> </div> <div> <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">转 </label> <input type="text" id="settings-major" class="input-field w-full"> </div> <div class="flex gap-4 pt-4"> <button type="submit" class="btn-primary flex-1">砖专 砖</button> <button type="button" id="close-settings" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all"></button> </div> </form> </div> </div>
    
    <div id="what-if-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-container p-8 w-full max-w-lg m-4 transform transition-all overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">砖 " "</h2>
                <button id="close-what-if-btn" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">住祝 拽专住 注转</h3>
                    <div id="what-if-courses" class="space-y-2 max-h-32 overflow-y-auto pr-2">
                        </div>
                    <button id="add-what-if-course-btn" class="w-full text-sm bg-gray-200 dark:bg-gray-700 p-2 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all font-semibold mt-2">
                        <i data-lucide="plus" class="inline w-4 h-4"></i> 住祝 拽专住 注转
                    </button>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">砖驻专 爪 拽</h3>
                    <div class="flex gap-2">
                        <select id="what-if-existing-course-select" class="input-field flex-1">
                            <option value="">专 拽专住 砖驻专...</option>
                            </select>
                        <button id="add-what-if-improvement-btn" class="btn-primary p-2.5">
                            <i data-lucide="plus"></i>
                        </button>
                    </div>
                    <div id="what-if-improvements-list" class="space-y-2 mt-3 max-h-32 overflow-y-auto pr-2">
                        </div>
                </div>

                <hr class="my-4 border-gray-200 dark:border-gray-700">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">爪注 砖 砖 :</h3>
                    <p id="what-if-result" class="text-5xl font-bold stat-number mt-2 inline-block">0.00</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">住住 注 <span id="what-if-credits-info"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div id="set-goal-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4 z-50"> <div class="modal-container p-8 max-w-sm w-full"> <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">专转 注 爪注</h2> <button id="close-set-goal-btn" class="icon-btn text-gray-600 dark:text-gray-300"> <i data-lucide="x"></i> </button> </div> <form id="set-goal-form" class="space-y-4"> <div> <label for="target-average-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">注 爪注 专爪</label> <input type="number" id="target-average-input" step="0.1" min="0" max="100" class="input-field w-full" placeholder=": 90.5"> </div> <div class="flex gap-4 pt-4"> <button type="submit" class="btn-primary flex-1">砖专 注</button> </div> </form> </div> </div>

    <div id="shield-calculator-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-container p-8 w-full max-w-md m-4 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">砖 </h2>
                <button id="close-shield-calculator-btn" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="shield-calculator-form" class="space-y-4">
                <p class="text-gray-600 dark:text-gray-400 text-sm"> 转 转    砖 转 爪 住驻 砖.</p>
                
                <div>
                    <label for="shield-grade" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">爪  (0-100)</label>
                    <input type="number" id="shield-grade" min="0" max="100" class="input-field" placeholder=": 80">
                </div>
                
                <div>
                    <label for="shield-percentage" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">  (0-100%)</label>
                    <input type="number" id="shield-percentage" min="0" max="100" class="input-field" placeholder=": 30">
                </div>

                <div>
                    <label for="exam-grade" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">爪  (0-100)</label>
                    <input type="number" id="exam-grade" min="0" max="100" class="input-field" placeholder=": 60">
                </div>

                <hr class="my-4 border-gray-200 dark:border-gray-700">
                
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">爪 住驻 砖:</h3>
                    <p id="final-grade-result" class="text-5xl font-bold stat-number mt-2 inline-block">---</p>
                    <p id="needed-exam-grade" class="text-sm text-gray-500 dark:text-gray-400 mt-2 hidden">
                         拽 爪 注专 (55), 注 拽 --- .
                    </p>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ... (专转 Firebase) ...
        const firebaseConfig = {
            apiKey: "AIzaSyDj1V85FXrcZ8Tg1kezkTsO50bgMOLcnPk",
            authDomain: "circademic-582dc.firebaseapp.com",
            projectId: "circademic-582dc",
            storageBucket: "circademic-582dc.firebasestorage.app",
            messagingSenderId: "296566462689",
            appId: "1:296566462689:web:d23a6f74078de2332bbfa0",
            measurementId: "G-SPD143KGDK"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;
        let academicData = null;
        let liveGradeChart = null;
        let printGradeChart = null;
        
        // --- 住驻转 砖转  专驻 驻 ---
        let moedChartDashboard = null;
        const chartDefaultFont = { family: "'Heebo', sans-serif", size: 12 };

        let loadingScreen, app, darkModeToggle, sidebar, mobileMenuToggle, mobileOverlay;
        let settingsModal, profileSettingsBtn, closeSettingsBtn, settingsForm;
        
        let whatIfModal, closeWhatIfBtn, whatIfCoursesContainer, whatIfResultEl, 
            whatIfCreditsInfoEl, addWhatIfCourseBtn, whatIfExistingCourseSelect,
            addWhatIfImprovementBtn, whatIfImprovementsList;
        
        let setGoalModal, setGoalForm, closeSetGoalBtn, targetAverageInput;
        
        let addActiveCoursesBtn, activeCoursesModal, closeActiveCoursesModal, activeSemesterForm,
            activeCoursesInput, activeCreditsInput, clearActiveSemesterBtn,
            activeCreditsDisplay, activeCreditsValue;

        let shieldCalculatorBtn, shieldCalculatorModal, closeShieldCalculatorBtn,
            shieldCalculatorForm, shieldGradeInput, shieldPercentageInput, examGradeInput,
            finalGradeResult, neededExamGrade;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;

                // 转 砖转 DOM
                loadingScreen = document.getElementById('loading-screen');
                app = document.getElementById('app');
                darkModeToggle = document.getElementById('dark-mode-toggle');
                sidebar = document.getElementById('sidebar');
                mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                mobileOverlay = document.getElementById('mobile-overlay');
                settingsModal = document.getElementById('settings-modal');
                profileSettingsBtn = document.getElementById('profile-settings');
                closeSettingsBtn = document.getElementById('close-settings');
                settingsForm = document.getElementById('settings-form');
                
                whatIfModal = document.getElementById('what-if-modal');
                closeWhatIfBtn = document.getElementById('close-what-if-btn');
                whatIfCoursesContainer = document.getElementById('what-if-courses');
                whatIfResultEl = document.getElementById('what-if-result');
                whatIfCreditsInfoEl = document.getElementById('what-if-credits-info');
                addWhatIfCourseBtn = document.getElementById('add-what-if-course-btn');
                whatIfExistingCourseSelect = document.getElementById('what-if-existing-course-select');
                addWhatIfImprovementBtn = document.getElementById('add-what-if-improvement-btn');
                whatIfImprovementsList = document.getElementById('what-if-improvements-list');

                setGoalModal = document.getElementById('set-goal-modal');
                setGoalForm = document.getElementById('set-goal-form');
                closeSetGoalBtn = document.getElementById('close-set-goal-btn');
                targetAverageInput = document.getElementById('target-average-input');
                
                addActiveCoursesBtn = document.getElementById('add-active-courses-btn');
                activeCoursesModal = document.getElementById('active-courses-modal');
                closeActiveCoursesModal = document.getElementById('close-active-courses-modal');
                activeSemesterForm = document.getElementById('active-semester-form');
                activeCoursesInput = document.getElementById('active-courses-input');
                activeCreditsInput = document.getElementById('active-credits-input');
                clearActiveSemesterBtn = document.getElementById('clear-active-semester-btn');
                activeCreditsDisplay = document.getElementById('active-credits-display');
                activeCreditsValue = document.getElementById('active-credits-value');
                
                shieldCalculatorBtn = document.getElementById('shield-calculator-btn');
                shieldCalculatorModal = document.getElementById('shield-calculator-modal');
                closeShieldCalculatorBtn = document.getElementById('close-shield-calculator-btn');
                shieldCalculatorForm = document.getElementById('shield-calculator-form');
                shieldGradeInput = document.getElementById('shield-grade');
                shieldPercentageInput = document.getElementById('shield-percentage');
                examGradeInput = document.getElementById('exam-grade');
                finalGradeResult = document.getElementById('final-grade-result');
                neededExamGrade = document.getElementById('needed-exam-grade');
                
                await loadUserData();
                await loadAcademicData();
                updateUserProfile();
                initializeDashboard(); 
                loadingScreen.classList.add('hidden');
                app.classList.remove('hidden');
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadUserData(){try{const doc=await db.collection('users').doc(currentUser.uid).get();if(doc.exists){userData=doc.data()}}catch(error){console.error('Error loading user data:',error)}}
        
        async function loadAcademicData(){
            try {
                const doc = await db.collection('academicData').doc(currentUser.uid).get();
                if (doc.exists) {
                    academicData = doc.data();
                    
                    if (!academicData.userInfo) {
                         academicData.userInfo = { name:currentUser.displayName||'砖转砖',institution:'',major:'',requiredCredits:120,categories:['','专','','住驻专'] };
                    }
                    academicData.userInfo.activeSemesterCourses = academicData.userInfo.activeSemesterCourses || null;
                    academicData.userInfo.activeSemesterCredits = academicData.userInfo.activeSemesterCredits || null;

                } else {
                    academicData = {
                        courses:[],
                        userInfo: {
                            name:currentUser.displayName||'砖转砖',
                            institution:'',
                            major:'',
                            requiredCredits:120,
                            categories:['','专','','住驻专'],
                            activeSemesterCourses: null,
                            activeSemesterCredits: null
                        }
                    };
                    await db.collection('academicData').doc(currentUser.uid).set(academicData);
                }
                updateStatistics();
            } catch(error) {
                console.error('Error loading academic data:',error);
            }
        }
        
        function updateUserProfile(){const userName=userData?.name||academicData?.userInfo?.name||currentUser.displayName||'砖转砖';const userEmail=userData?.email||currentUser.email;const initial=userName.charAt(0).toUpperCase();document.getElementById('user-name').textContent=userName;document.getElementById('user-email').textContent=userEmail;document.getElementById('user-initial').textContent=initial;document.getElementById('welcome-name').textContent=userName}


        function updateStatistics() {
            if (!academicData) return;
            const courses = academicData.courses || [];
            const userInfo = academicData.userInfo || {};
            
            const gradedCourses = courses.filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined));
            
            let avgGrade = 0;
            if (gradedCourses.length > 0) {
                const totalWeighted = gradedCourses.reduce((sum, c) => sum + (c.grade * c.credits), 0);
                const totalCreditsForAvg = gradedCourses.reduce((sum, c) => sum + c.credits, 0);
                avgGrade = totalCreditsForAvg > 0 ? (totalWeighted / totalCreditsForAvg) : 0;
            }

            const totalCredits = courses.reduce((sum, c) => sum + c.credits, 0);
            const requiredCredits = userInfo.requiredCredits || 120;

            let highestGradedSemester = 0;
            if (gradedCourses.length > 0) {
                highestGradedSemester = Math.max(...gradedCourses.map(c => c.semester || 0));
            }
            const currentSemester = highestGradedSemester > 0 ? highestGradedSemester + 1 : 1;

            const activeCourseCount = userInfo.activeSemesterCourses || 0;
            const activeCredits = userInfo.activeSemesterCredits || null;

            document.getElementById('avg-grade').textContent = avgGrade.toFixed(2);
            document.getElementById('total-credits').textContent = totalCredits;
            document.getElementById('required-credits').textContent = requiredCredits;
            
            if (activeCredits && activeCredits > 0) {
                activeCreditsValue.textContent = activeCredits;
                activeCreditsDisplay.classList.remove('hidden');
            } else {
                activeCreditsDisplay.classList.add('hidden');
            }

            document.getElementById('active-courses').textContent = activeCourseCount;
            document.getElementById('current-semester').textContent = currentSemester;
            document.getElementById('current-year').textContent = getYearName(currentSemester);
            
            if (userInfo.targetAverage) {
                document.getElementById('target-average').textContent = parseFloat(userInfo.targetAverage).toFixed(2);
                targetAverageInput.value = userInfo.targetAverage;
            } else {
                 document.getElementById('target-average').textContent = " 专";
                 targetAverageInput.value = '';
            }

            const progress = Math.min(100, (totalCredits / requiredCredits) * 100);
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-percentage').textContent = `${progress.toFixed(1)}%`;

            const mandatoryCourses = courses.filter(c => c.category === '');
            const electiveCourses = courses.filter(c => c.category === '专');
            document.getElementById('mandatory-progress').textContent = `${mandatoryCourses.length}/--`;
            document.getElementById('elective-progress').textContent = `${electiveCourses.length}/--`;

            // --- 住驻转 拽转 爪 / ---
            let highestGrade = { name: '-', grade: 0 };
            let lowestGrade = { name: '-', grade: 101 };
            if (gradedCourses.length > 0) {
                highestGrade = gradedCourses.reduce((max, c) => c.grade > max.grade ? c : max, gradedCourses[0]);
                lowestGrade = gradedCourses.reduce((min, c) => c.grade < min.grade ? c : min, gradedCourses[0]);
                document.getElementById('highest-grade-stat').textContent = `${highestGrade.name} (${highestGrade.grade})`;
                document.getElementById('lowest-grade-stat').textContent = `${lowestGrade.name} (${lowestGrade.grade})`;
            } else {
                document.getElementById('highest-grade-stat').textContent = '-';
                document.getElementById('lowest-grade-stat').textContent = '-';
            }
            // ------------------------------------

            // --- 拽专 驻拽爪转 专专 砖转 ---
            renderSemesterAveragesDashboard();
            renderMoedChartDashboard();
            // ------------------------------------
        }

        function getYearName(semester){const year=Math.ceil(semester/2);const yearNames=['','','','','',''];return yearNames[year-1]||year.toString()}


        function initializeDashboard() {
            lucide.createIcons();
            const darkMode = localStorage.getItem('theme') === 'dark';
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }

            const liveCtx = document.getElementById('grade-trend-chart').getContext('2d');
            liveGradeChart = createGradeChart(liveCtx, darkMode);
            
            // --- 拽专 专专 专祝 注 ---
            renderMoedChartDashboard();
            
            // 转  住住专 
            addActiveCoursesBtn.addEventListener('click', openActiveSemesterModal);
            closeActiveCoursesModal.addEventListener('click', () => {
                activeCoursesModal.classList.add('hidden');
                activeCoursesModal.classList.remove('flex');
            });
            activeSemesterForm.addEventListener('submit', saveActiveSemesterData);
            clearActiveSemesterBtn.addEventListener('click', clearActiveSemesterData);

            // 转 砖 
            shieldCalculatorBtn.addEventListener('click', () => {
                shieldCalculatorModal.classList.remove('hidden');
                shieldCalculatorModal.classList.add('flex');
            });
            const closeShieldModal = () => {
                shieldCalculatorModal.classList.add('hidden');
                shieldCalculatorModal.classList.remove('flex');
                shieldCalculatorForm.reset();
                calculateShieldGrade();
            }
            closeShieldCalculatorBtn.addEventListener('click', closeShieldModal);
            shieldCalculatorModal.addEventListener('click', (e) => {
                if (e.target === shieldCalculatorModal) {
                    closeShieldModal();
                }
            });
            shieldCalculatorForm.addEventListener('input', calculateShieldGrade);
            
            // 转 砖 " "
            document.getElementById('what-if-btn').addEventListener('click', () => { 
                whatIfModal.classList.remove('hidden');
                whatIfModal.classList.add('flex');
                populateWhatIfDropdown();
                resetAndCalculateWhatIf();
            });
            closeWhatIfBtn.addEventListener('click', () => { 
                whatIfModal.classList.add('hidden');
                whatIfModal.classList.remove('flex');
            });
            
            addWhatIfCourseBtn.addEventListener('click', addWhatIfCourseRow_WhatIf);
            addWhatIfImprovementBtn.addEventListener('click', addWhatIfImprovementRow);
            
            whatIfModal.addEventListener('input', calculateWhatIf);

            // 转 拽转
            document.getElementById('print-report-btn').addEventListener('click', printReport);
            document.getElementById('set-goal-btn').addEventListener('click', () => { 
                setGoalModal.classList.remove('hidden');
                setGoalModal.classList.add('flex');
            });
            closeSetGoalBtn.addEventListener('click', () => { 
                setGoalModal.classList.add('hidden');
                setGoalModal.classList.remove('flex');
            });
            setGoalForm.addEventListener('submit', saveTargetGoal);

            // --- 住驻转  拽专 住住专 ---
            document.getElementById('semester-averages-dashboard').addEventListener('click', (e) => {
                const header = e.target.closest('.semester-accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.icon-toggle');
                    header.classList.toggle('open');
                    if (icon) icon.classList.toggle('open');
                    content.classList.toggle('open');
                }
            });
            // -------------------------------------

            // 转 转驻专 爪
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                lucide.createIcons();
                
                if (liveGradeChart) liveGradeChart.destroy();
                const liveCtx = document.getElementById('grade-trend-chart').getContext('2d');
                liveGradeChart = createGradeChart(liveCtx, isDark);
                
                // --- 专专 砖 砖 专祝 注 ---
                if (moedChartDashboard) moedChartDashboard.destroy();
                renderMoedChartDashboard();
                // ---------------------------------
            });

            mobileMenuToggle.addEventListener('click', () => { sidebar.classList.toggle('open'); mobileOverlay.classList.toggle('active'); });
            mobileOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); mobileOverlay.classList.remove('active'); });
            profileSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden'); settingsModal.classList.add('flex');
                document.getElementById('settings-name').value = userData?.name || academicData?.userInfo?.name || '';
                document.getElementById('settings-institution').value = userData?.institution || academicData?.userInfo?.institution || '';
                document.getElementById('settings-major').value = userData?.major || academicData?.userInfo?.major || '';
            });
            closeSettingsBtn.addEventListener('click', () => { settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); });
            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('settings-name').value;
                const institution = document.getElementById('settings-institution').value;
                const major = document.getElementById('settings-major').value;
                try {
                    await db.collection('users').doc(currentUser.uid).update({ name, institution, major });
                    await db.collection('academicData').doc(currentUser.uid).update({
                        'userInfo.name': name,
                        'userInfo.institution': institution,
                        'userInfo.major': major
                    });
                    if (name) await currentUser.updateProfile({ displayName: name });
                    if (userData) { userData.name = name; userData.institution = institution; userData.major = major; }
                    if (academicData) { academicData.userInfo.name = name; academicData.userInfo.institution = institution; academicData.userInfo.major = major; }
                    updateUserProfile();
                    settingsModal.classList.add('hidden');
                    settingsModal.classList.remove('flex');
                    alert('专转 砖专 爪!');
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('专注 砖 砖专转 专转.');
                }
            });
            document.getElementById('logout-btn').addEventListener('click', async () => { if (confirm(' 转  砖专爪 爪转?')) { try { await auth.signOut(); window.location.href = 'login.html'; } catch (error) { console.error('Error signing out:', error); } } });

            document.querySelectorAll('#schedule-link, #notes-link, #tasks-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('驻爪壮专    拽专! ');
                });
            });
        }

        // --- 驻拽爪转 砖转 砖住驻 ---

        function renderMoedChartDashboard() {
            if (!academicData || !document.getElementById('moed-chart-dashboard')) return;
            if (moedChartDashboard) moedChartDashboard.destroy();
            
            let moedA = academicData.courses.filter(c => !c.isMoedB).length;
            let moedB = academicData.courses.filter(c => c.isMoedB).length;
            const ctx = document.getElementById('moed-chart-dashboard').getContext('2d');
            
            const gradient1 = ctx.createLinearGradient(0, 0, 0, 300);
            gradient1.addColorStop(0, '#3B82F6');
            gradient1.addColorStop(1, '#8B5CF6');
            const gradient2 = ctx.createLinearGradient(0, 0, 0, 300);
            gradient2.addColorStop(0, '#EF4444');
            gradient2.addColorStop(1, '#DC2626');
            
            const isDark = document.documentElement.classList.contains('dark');

            moedChartDashboard = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['注 \'', '注 \''],
                    datasets: [{ data: [moedA, moedB], backgroundColor: [gradient1, gradient2], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                color: isDark ? '#e5e7eb' : '#4b5563', 
                                font: chartDefaultFont, 
                                padding: 15 
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderSemesterAveragesDashboard() {
            const element = document.getElementById('semester-averages-dashboard');
            if (!academicData || !element) return;
            element.innerHTML = '';
            
            const groups = {};
            const coursesWithGrades = academicData.courses.filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined));
            
            coursesWithGrades.forEach(c => {
                const key = c.semester || ' 住住专';
                if (!groups[key]) {
                    groups[key] = { weightedSum: 0, credits: 0, courses: [] };
                }
                groups[key].weightedSum += c.grade * c.credits;
                groups[key].credits += c.credits;
                groups[key].courses.push({ name: c.name, grade: c.grade });
            });
            
            const keys = Object.keys(groups).sort((a,b) => (a === ' 住住专' ? 1 : b === ' 住住专' ? -1 : a-b));
            
            if (keys.length === 0) {
                element.innerHTML = `<p class="text-gray-400"> 转 爪.</p>`;
                return;
            }
            
            keys.forEach(key => {
                const avg = (groups[key].weightedSum / groups[key].credits).toFixed(2);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'semester-accordion-item';

                let courseListHtml = '<ul class="text-sm space-y-1 text-gray-600 dark:text-gray-400 pl-4">';
                groups[key].courses.sort((a,b) => b.grade - a.grade).forEach(course => {
                    courseListHtml += `<li class="flex justify-between"><span>${course.name}</span><span class="font-bold">${course.grade}</span></li>`;
                });
                courseListHtml += '</ul>';

                itemDiv.innerHTML = `
                    <div class="semester-accordion-header">
                        <div class="flex items-center">
                            <i data-lucide="chevron-down" class="w-4 h-4 icon-toggle text-gray-500"></i>
                            <span class="font-semibold text-gray-700 dark:text-gray-300">住住专 ${key}</span>
                        </div>
                        <span class="font-bold badge text-sm">${avg}</span>
                    </div>
                    <div class="semester-accordion-content">
                        ${courseListHtml}
                    </div>
                `;
                element.appendChild(itemDiv);
            });
            lucide.createIcons();
        }

        // ---------------------------------
        
        function createGradeChart(ctx, isDark) {
            if (!academicData) return null;
            const courses = academicData.courses || [];
            const semesterData = {};
            const gradedCourses = courses.filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined));
            
            gradedCourses.forEach(course => {
                if (!course.isPassFail && (course.grade !== null && course.grade !== undefined)) {
                    const sem = course.semester || 1;
                    if (!semesterData[sem]) semesterData[sem] = { totalWeighted: 0, totalCredits: 0 };
                    semesterData[sem].totalWeighted += course.grade * course.credits;
                    semesterData[sem].totalCredits += course.credits;
                }
            });
            const labels = Object.keys(semesterData).sort((a, b) => a - b);
            const data = labels.map(sem => {
                const d = semesterData[sem];
                return d.totalCredits > 0 ? (d.totalWeighted / d.totalCredits) : 0;
            });
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { min: 0, max: 100, ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { color: isDark ? '#374151' : '#e5e7eb' } },
                    x: { ticks: { color: isDark ? '#9ca3af' : '#6b7280' }, grid: { display: false } }
                }
            };
            const chartData = {
                labels: labels.map(l => `住住专 ${l}`),
                datasets: [{
                    label: '爪注 住住专', data: data, borderColor: '#3B82F6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3, tension: 0.4, fill: true, pointRadius: 6, pointHoverRadius: 8,
                    pointBackgroundColor: '#3B82F6', pointBorderColor: isDark ? '#1E293B' : '#fff', pointBorderWidth: 2
                }]
            };
            
            if (ctx.canvas.id === 'grade-trend-chart' && liveGradeChart) {
                liveGradeChart.destroy();
            }
            if (ctx.canvas.id === 'print-grade-trend-chart' && printGradeChart) {
                printGradeChart.destroy();
            }
            
            return new Chart(ctx, { type: 'line', data: chartData, options: options });
        }


        function printReport() {
            if (!academicData) return;
            const courses = academicData.courses || [];
            const userInfo = academicData.userInfo || {};
            const gradedCourses = courses.filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined));
            const studentName = userData?.name || userInfo.name || currentUser.displayName || '住';
            document.getElementById('print-student-name').textContent = ` 注专: ${studentName}`;
            let avgGrade = 0;
            if (gradedCourses.length > 0) { avgGrade = (gradedCourses.reduce((sum, c) => sum + (c.grade * c.credits), 0) / gradedCourses.reduce((sum, c) => sum + c.credits, 0)) || 0; }
            const totalCredits = courses.reduce((sum, c) => sum + c.credits, 0);
            const requiredCredits = userInfo.requiredCredits || 120;
            document.getElementById('print-avg-grade').textContent = avgGrade.toFixed(2);
            document.getElementById('print-total-credits').textContent = totalCredits;
            document.getElementById('print-required-credits').textContent = requiredCredits;
            const progress = Math.min(100, (totalCredits / requiredCredits) * 100);
            document.getElementById('print-progress-bar').style.width = `${progress}%`;
            document.getElementById('print-progress-percent').textContent = `${progress.toFixed(1)}%`;
            if (gradedCourses.length > 0) {
                const highest = gradedCourses.reduce((max, c) => c.grade > max.grade ? c : max, gradedCourses[0]);
                const lowest = gradedCourses.reduce((min, c) => c.grade < min.grade ? c : min, gradedCourses[0]);
                document.getElementById('print-highest-grade').innerHTML = `${highest.name} (<span style="color: #059669;">${highest.grade}</span>)`;
                document.getElementById('print-lowest-grade').innerHTML = `${lowest.name} (<span style="color: #EF4444;">${lowest.grade}</span>)`;
            } else {
                document.getElementById('print-highest-grade').textContent = '-';
                document.getElementById('print-lowest-grade').textContent = '-';
            }
            const semesterData = {};
            gradedCourses.forEach(course => {
                const sem = course.semester || 1;
                if (!semesterData[sem]) semesterData[sem] = { totalWeighted: 0, totalCredits: 0 };
                semesterData[sem].totalWeighted += course.grade * course.credits;
                semesterData[sem].totalCredits += course.credits;
            });
            const semesterEl = document.getElementById('print-semester-averages');
            semesterEl.innerHTML = '';
            const sortedSemesters = Object.keys(semesterData).sort((a, b) => a - b);
            if (sortedSemesters.length === 0) {
                semesterEl.innerHTML = '<li> 转</li>';
            } else {
                sortedSemesters.forEach(sem => {
                    const avg = (semesterData[sem].totalWeighted / semesterData[sem].totalCredits).toFixed(2);
                    semesterEl.innerHTML += `<li style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #E5E7EB;"><span class="course-name" style="font-weight: 500; color: #111827;">住住专 ${sem}</span><span class="course-grade" style="font-weight: 700; color: #2563EB;">${avg}</span></li>`;
                });
            }
            const printCtx = document.getElementById('print-grade-trend-chart').getContext('2d');
            if (printGradeChart) { printGradeChart.destroy(); }
            printGradeChart = createGradeChart(printCtx, false); 
            setTimeout(() => { window.print(); }, 300);
        }

        function openActiveSemesterModal() {
            activeCoursesInput.value = academicData.userInfo.activeSemesterCourses || '';
            activeCreditsInput.value = academicData.userInfo.activeSemesterCredits || '';
            
            activeCoursesModal.classList.remove('hidden');
            activeCoursesModal.classList.add('flex');
            lucide.createIcons();
        }

        async function saveActiveSemesterData(e) {
            e.preventDefault();
            
            const coursesCount = parseInt(activeCoursesInput.value) || null;
            const creditsCount = parseFloat(activeCreditsInput.value) || null;
            
            try {
                await db.collection('academicData').doc(currentUser.uid).update({
                    'userInfo.activeSemesterCourses': coursesCount,
                    'userInfo.activeSemesterCredits': creditsCount
                });
                
                academicData.userInfo.activeSemesterCourses = coursesCount;
                academicData.userInfo.activeSemesterCredits = creditsCount;
                
                updateStatistics();
                
                activeCoursesModal.classList.add('hidden');
                activeCoursesModal.classList.remove('flex');
                alert('转 住住专 砖专 爪!');

            } catch (error) {
                console.error('Error saving active semester data:', error);
                alert('专注 砖 砖专转 转.');
            }
        }

        async function clearActiveSemesterData() {
             try {
                await db.collection('academicData').doc(currentUser.uid).update({
                    'userInfo.activeSemesterCourses': null,
                    'userInfo.activeSemesterCredits': null
                });
                
                academicData.userInfo.activeSemesterCourses = null;
                academicData.userInfo.activeSemesterCredits = null;
                
                updateStatistics();
                
                activeCoursesModal.classList.add('hidden');
                activeCoursesModal.classList.remove('flex');
            } catch (error) {
                console.error('Error clearing active semester data:', error);
                alert('专注 砖 驻住 转.');
            }
        }

        function calculateShieldGrade() {
            const shieldGrade = parseFloat(shieldGradeInput.value);
            const shieldPercentage = parseFloat(shieldPercentageInput.value);
            const examGrade = parseFloat(examGradeInput.value);

            finalGradeResult.textContent = '---';
            neededExamGrade.classList.add('hidden');

            if (isNaN(shieldGrade) || isNaN(shieldPercentage) || shieldPercentage < 0 || shieldPercentage > 100) {
                return;
            }

            const shieldWeight = shieldPercentage / 100;
            const examWeight = 1 - shieldWeight;

            if (!isNaN(examGrade)) {
                const finalGrade = (shieldGrade * shieldWeight) + (examGrade * examWeight);
                finalGradeResult.textContent = finalGrade.toFixed(1);
                
            } else if (examWeight > 0) {
                const neededGrade = (55 - (shieldGrade * shieldWeight)) / examWeight;
                
                neededExamGrade.innerHTML = ` 拽 爪 注专 (55), 注 拽 <strong class="text-gray-800 dark:text-gray-200">${neededGrade.toFixed(1)}</strong> .`;
                neededExamGrade.classList.remove('hidden');
            }
        }
        
        function populateWhatIfDropdown() {
            if (!academicData || !academicData.courses) return;
            
            whatIfExistingCourseSelect.innerHTML = '<option value="">专 拽专住 砖驻专...</option>';
            
            const gradedCourses = academicData.courses
                .filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined))
                .sort((a, b) => a.name.localeCompare(b.name, 'he'));
                
            gradedCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.name} (${course.grade})`;
                whatIfExistingCourseSelect.add(option);
            });
        }

        function addWhatIfImprovementRow() {
            const selectedId = whatIfExistingCourseSelect.value;
            if (!selectedId) return;

            const course = academicData.courses.find(c => c.id == selectedId);
            if (!course) return;

            if (document.querySelector(`.what-if-improvement-row[data-id="${course.id}"]`)) {
                alert('拽专住  专 住祝 专砖转 砖驻专.');
                return;
            }

            const row = document.createElement('div');
row.className = 'what-if-improvement-row grid grid-cols-3 gap-2 items-center';
row.dataset.id = course.id;
row.dataset.originalGrade = course.grade;
row.dataset.credits = course.credits;

// --- 砖: 住驻转 驻转专 拽 ---
row.innerHTML = `
    <span class_name="text-sm text-gray-700 dark:text-gray-300 truncate" title="${course.name}">
        ${course.name} (拽 ${course.grade})
    </span>
    <input type="number" placeholder="爪 砖" class="what-if-new-grade input-field" min="0" max="100">
    <button type="button" class="remove-what-if-row-btn icon-btn" style="background-color: #FEE2E2; color: #EF4444; width: 2.5rem; height: 2.5rem;">
        <i data-lucide="x" class="w-4 h-4"></i>
    </button>
`;
// --------------------------------

whatIfImprovementsList.appendChild(row);
lucide.createIcons(); // 拽专 专注 拽

// --- 住驻转  驻转专 拽 砖 ---
row.querySelector('.remove-what-if-row-btn').addEventListener('click', () => {
    row.remove();
    calculateWhatIf(); // 砖 砖 专 拽
});
// -----------------------------------

whatIfExistingCourseSelect.value = '';
calculateWhatIf();
        }

        function addWhatIfCourseRow_WhatIf(){
            const row=document.createElement('div');
            row.className='what-if-row grid grid-cols-3 gap-2 items-center'; // --- 砖: 3 注转
            row.innerHTML=`
                <input type="number" placeholder="爪 注转 (0-100)" class="what-if-grade input-field col-span-1">
                <input type="number" step="0.5" placeholder='" 注转' class="what-if-credits input-field col-span-1">
                <button type="button" class="remove-what-if-row-btn icon-btn col-span-1" style="background-color: #FEE2E2; color: #EF4444; width: 2.5rem; height: 2.5rem; margin-right: auto;">
                     <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            whatIfCoursesContainer.appendChild(row);
            lucide.createIcons(); // 拽专 专注 拽
            
            // --- 住驻转  驻转专 拽 砖 ---
            row.querySelector('.remove-what-if-row-btn').addEventListener('click', () => {
                row.remove();
                calculateWhatIf(); // 砖 砖 专 拽
            });
            // -----------------------------------
        }
        
        function calculateWhatIf() {
            if(!academicData) return;

            const coursesWithGrades = academicData.courses.filter(c => !c.isPassFail && (c.grade !== null && c.grade !== undefined));
            let currentWeightedSum = coursesWithGrades.reduce((sum, c) => sum + (c.grade * c.credits), 0);
            let currentCreditsForAvg = coursesWithGrades.reduce((sum, c) => sum + c.credits, 0);

            const improvementRows = document.querySelectorAll('.what-if-improvement-row');
            const improvedCourseIds = new Set();
            
            improvementRows.forEach(row => {
                const newGrade = parseFloat(row.querySelector('.what-if-new-grade').value);
                const courseId = row.dataset.id;
                
                if (isNaN(newGrade) || newGrade < 0 || newGrade > 100) return;
                
                const originalCourse = coursesWithGrades.find(c => c.id == courseId);
                if (!originalCourse) return;

                improvedCourseIds.add(originalCourse.id);
                
                currentWeightedSum -= (originalCourse.grade * originalCourse.credits);
                currentWeightedSum += (newGrade * originalCourse.credits);
            });

            document.querySelectorAll('.what-if-row').forEach(row => {
                const grade = parseFloat(row.querySelector('.what-if-grade').value);
                const credits = parseFloat(row.querySelector('.what-if-credits').value);
                
                if (!isNaN(grade) && !isNaN(credits) && grade >= 0 && grade <= 100 && credits > 0) {
                    currentWeightedSum += grade * credits;
                    currentCreditsForAvg += credits;
                }
            });

            const newAvg = currentCreditsForAvg > 0 ? (currentWeightedSum / currentCreditsForAvg) : 0;
            whatIfResultEl.textContent = newAvg.toFixed(2);
            whatIfCreditsInfoEl.textContent = `住" ${currentCreditsForAvg.toFixed(1)} " 砖`;
        }
        
        function resetAndCalculateWhatIf(){
            whatIfCoursesContainer.innerHTML = '';
            whatIfImprovementsList.innerHTML = '';
            addWhatIfCourseRow_WhatIf();
            calculateWhatIf();
        }
        
        async function saveTargetGoal(e){
            e.preventDefault();
            const target=parseFloat(targetAverageInput.value);
            if(isNaN(target)||target<0||target>100){
                alert("  注 拽 ( 0 -100).");
                return;
            }
            try{
                await db.collection('academicData').doc(currentUser.uid).update({'userInfo.targetAverage':target});
                academicData.userInfo.targetAverage=target;
                updateStatistics();
                setGoalModal.classList.add('hidden');
                setGoalModal.classList.remove('flex');
                alert("注 砖专 爪!");
            } catch(error){
                console.error("Error saving target goal:",error);
                alert("专注 砖 砖专转 注.");
            }
        }
        
    </script>
</body>
</html>

