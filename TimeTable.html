<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" href="favicon2.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעצב מערכת שעות</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&family=Rubik:wght@600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Design System Variables */
        :root {
            /* Primary Colors */
            --primary: #3B82F6;
            --primary-light: #60A5FA;
            --primary-dark: #2563EB;
            
            /* Secondary Colors */
            --secondary: #8B5CF6;
            --secondary-light: #A78BFA;
            --secondary-dark: #7C3AED;
            
            /* Accent Colors */
            --accent: #F59E0B;
            --accent-light: #FBBF24;
            --accent-dark: #D97706;
            
            /* Success Colors */
            --success: #10B981;
            --success-light: #34D399;
            --success-dark: #059669;
            
            /* Background Colors */
            --bg-light: #F9FAFB;
            --bg-lighter: #FFFFFF;
            --bg-dark: #0F172A;
            --bg-darker: #030712;
            --bg-dark-card: #1E293B;
            
            /* Text Colors */
            --text-primary-light: #111827;
            --text-secondary-light: #6B7280;
            --text-primary-dark: #F9FAFB;
            --text-secondary-dark: #9CA3AF;
            
            /* Border Colors */
            --border-light: #E5E7EB;
            --border-dark: #374151;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Base Typography */
        body { 
            font-family: 'Heebo', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary-light);
            padding: 20px;
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        body.dark-mode {
            background: var(--bg-dark);
            color: var(--text-primary-dark);
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { 
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track { 
            background: var(--bg-light);
            border-radius: 10px;
        }
        body.dark-mode ::-webkit-scrollbar-track { 
            background: var(--bg-dark-card);
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
            background-clip: padding-box;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header with unified 3 buttons */
        header {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
        }

        body.dark-mode header {
            background: var(--bg-dark-card);
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header-title-section h1 {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title-section p {
            color: var(--text-secondary-light);
            font-size: 1rem;
        }

        body.dark-mode .header-title-section p {
            color: var(--text-secondary-dark);
        }

        /* Unified Icon Buttons (Settings, Info, Dark Mode) */
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 2.75rem;
            height: 2.75rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            color: var(--text-secondary-light);
            /* === ADDED for <a> tag styling === */
            text-decoration: none;
        }

        .icon-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }

        body.dark-mode .icon-btn {
            background: rgba(59, 130, 246, 0.15);
            color: var(--text-secondary-dark);
        }

        body.dark-mode .icon-btn:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Button Styles with Design System */
        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Heebo', sans-serif;
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-primary-light);
        }

        body.dark-mode .btn {
            background: rgba(156, 163, 175, 0.1);
            color: var(--text-primary-dark);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .theme-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .theme-selector select {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-light);
            background: white;
            color: var(--text-primary-light);
            cursor: pointer;
            font-size: 0.875rem;
            font-family: 'Heebo', sans-serif;
            transition: all 0.2s ease;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        body.dark-mode .theme-selector select {
            background: var(--bg-dark-card);
            color: var(--text-primary-dark);
            border-color: var(--border-dark);
        }

        body.dark-mode .theme-selector select:focus {
            border-color: var(--primary-light);
        }

        /* Download Button Special */
        .download-btn-special {
            padding: 0.875rem 1.75rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Rubik', sans-serif;
        }

        .download-btn-special:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
        }

        /* Stats Card */
        .stats {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out;
        }

        .stats:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        body.dark-mode .stats {
            background: var(--bg-dark-card);
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .stats:hover {
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .stats-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Rubik', sans-serif;
        }

        /* Table Wrapper */
        .table-wrapper {
            background: white;
            border-radius: var(--radius-lg);
            overflow: auto;
            max-height: 70vh;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.1);
            animation: fadeInUp 0.6s ease-out;
        }

        body.dark-mode .table-wrapper {
            background: var(--bg-dark-card);
            border-color: rgba(59, 130, 246, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead tr {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            border: 1px solid var(--border-light);
            font-family: 'Rubik', sans-serif;
        }

        body.dark-mode th {
            border-color: var(--border-dark);
        }

        /* Default Theme - Header with gradient */
        body.theme-default thead th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        /* Theme 1 - Header */
        body.theme-1 thead th {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        /* Theme 2 - Header */
        body.theme-2 thead th {
            background: linear-gradient(135deg, #0EA5E9, #0284C7);
            color: white;
        }

        /* Theme 3 - Header */
        body.theme-3 thead th {
            background: linear-gradient(135deg, #A855F7, #9333EA);
            color: white;
        }

        tbody th {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            font-weight: 600;
            padding: 1rem;
            width: 100px;
        }

        body.dark-mode tbody th {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--border-dark);
        }

        body.theme-1 tbody th {
            background: rgba(239, 68, 68, 0.1);
        }

        body.theme-2 tbody th {
            background: rgba(14, 165, 233, 0.1);
        }

        body.theme-3 tbody th {
            background: rgba(168, 85, 247, 0.1);
        }

        td {
            border: 1px solid var(--border-light);
            padding: 0;
            height: 80px;
            min-height: 80px;
            vertical-align: middle;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
        }

        body.dark-mode td {
            background: var(--bg-dark-card);
            border-color: var(--border-dark);
        }

        td:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        body.dark-mode td:hover {
            background: rgba(59, 130, 246, 0.15);
        }

        .content-cell {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-radius: 8px;
            overflow: hidden;
            color: white;
            transition: all 0.2s ease;
        }

        .content-cell:hover {
            transform: scale(1.02);
        }

        /* Color Palette - Default Theme with gradients */
        body.theme-default .cell-1 { background: linear-gradient(135deg, #EF4444, #DC2626); }
        body.theme-default .cell-2 { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        body.theme-default .cell-3 { background: linear-gradient(135deg, #06B6D4, #0891B2); }
        body.theme-default .cell-4 { background: linear-gradient(135deg, #10B981, #059669); }
        body.theme-default .cell-5 { background: linear-gradient(135deg, #F59E0B, #D97706); color: #333; }
        body.theme-default .cell-6 { background: linear-gradient(135deg, #F97316, #EA580C); }
        body.theme-default .cell-7 { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        body.theme-default .cell-8 { background: linear-gradient(135deg, #EC4899, #DB2777); }

        /* Theme 1 - Strong Colors with gradients */
        body.theme-1 .cell-1 { background: linear-gradient(135deg, #DC2626, #B91C1C); }
        body.theme-1 .cell-2 { background: linear-gradient(135deg, #F97316, #EA580C); }
        body.theme-1 .cell-3 { background: linear-gradient(135deg, #10B981, #059669); }
        body.theme-1 .cell-4 { background: linear-gradient(135deg, #0EA5E9, #0284C7); }
        body.theme-1 .cell-5 { background: linear-gradient(135deg, #1E40AF, #1E3A8A); }
        body.theme-1 .cell-6 { background: linear-gradient(135deg, #EC4899, #DB2777); }
        body.theme-1 .cell-7 { background: linear-gradient(135deg, #FBBF24, #F59E0B); color: #333; }
        body.theme-1 .cell-8 { background: linear-gradient(135deg, #0C4A6E, #075985); }

        /* Theme 2 - Soft Colors */
        body.theme-2 .cell-1 { background: linear-gradient(135deg, #C084FC, #A855F7); }
        body.theme-2 .cell-2 { background: linear-gradient(135deg, #FDA4AF, #FB7185); }
        body.theme-2 .cell-3 { background: linear-gradient(135deg, #FDBA74, #FB923C); }
        body.theme-2 .cell-4 { background: linear-gradient(135deg, #F9A8D4, #F472B6); }
        body.theme-2 .cell-5 { background: linear-gradient(135deg, #DDD6FE, #C4B5FD); }
        body.theme-2 .cell-6 { background: linear-gradient(135deg, #FCA5A5, #F87171); }
        body.theme-2 .cell-7 { background: linear-gradient(135deg, #BE185D, #9F1239); }
        body.theme-2 .cell-8 { background: linear-gradient(135deg, #A78BFA, #8B5CF6); }

        /* Theme 3 - Vibrant & Artistic */
        body.theme-3 .cell-1 { background: linear-gradient(135deg, #E11D48, #BE123C); }
        body.theme-3 .cell-2 { background: linear-gradient(135deg, #F97316, #EA580C); }
        body.theme-3 .cell-3 { background: linear-gradient(135deg, #FBBF24, #F59E0B); color: #333; }
        body.theme-3 .cell-4 { background: linear-gradient(135deg, #A855F7, #9333EA); }
        body.theme-3 .cell-5 { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        body.theme-3 .cell-6 { background: linear-gradient(135deg, #14B8A6, #0D9488); }
        body.theme-3 .cell-7 { background: linear-gradient(135deg, #EC4899, #DB2777); }
        body.theme-3 .cell-8 { background: linear-gradient(135deg, #F97316, #EA580C); }

        /* Minimal Theme - No Colors */
        body.theme-minimal thead th {
            background: var(--text-primary-light);
            color: white;
        }

        body.dark-mode.theme-minimal thead th {
            background: var(--text-primary-dark);
            color: var(--bg-dark);
        }

        body.theme-minimal tbody th {
            background: var(--bg-light);
        }

        body.dark-mode.theme-minimal tbody th {
            background: rgba(255, 255, 255, 0.05);
        }

        body.theme-minimal .cell-1,
        body.theme-minimal .cell-2,
        body.theme-minimal .cell-3,
        body.theme-minimal .cell-4,
        body.theme-minimal .cell-5,
        body.theme-minimal .cell-6,
        body.theme-minimal .cell-7,
        body.theme-minimal .cell-8 {
            background: white !important;
            color: var(--text-primary-light) !important;
            border: 2px solid var(--border-light);
        }

        body.dark-mode.theme-minimal .cell-1,
        body.dark-mode.theme-minimal .cell-2,
        body.dark-mode.theme-minimal .cell-3,
        body.dark-mode.theme-minimal .cell-4,
        body.dark-mode.theme-minimal .cell-5,
        body.dark-mode.theme-minimal .cell-6,
        body.dark-mode.theme-minimal .cell-7,
        body.dark-mode.theme-minimal .cell-8 {
            background: var(--bg-dark-card) !important;
            color: var(--text-primary-dark) !important;
            border: 2px solid var(--border-dark);
        }

        .cell-title {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 2px;
            font-family: 'Rubik', sans-serif;
        }

        .cell-subtitle {
            font-size: 0.75rem;
            font-weight: 500;
            opacity: 0.95;
        }

        .cell-details {
            font-size: 0.688rem;
            font-weight: normal;
            opacity: 0.85;
            line-height: 1.3;
        }

        textarea {
            width: 100%;
            height: 100%;
            border: 2px solid var(--primary);
            padding: 0.5rem;
            font-family: 'Heebo', sans-serif;
            font-size: 0.875rem;
            resize: none;
            background: white;
            color: var(--text-primary-light);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        body.dark-mode textarea {
            background: var(--bg-dark-card);
            color: var(--text-primary-dark);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fadeInUp 0.3s ease-out;
        }

        body.dark-mode .modal-content {
            background: var(--bg-dark-card);
        }

        .modal-content h2 {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
        }

        .modal-content h3 {
            color: var(--primary);
            margin: 1.5rem 0 0.75rem;
            font-size: 1.25rem;
        }

        body.dark-mode .modal-content h3 {
            color: var(--primary-light);
        }

        .modal-content p, .modal-content ul {
            color: var(--text-primary-light);
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        body.dark-mode .modal-content p,
        body.dark-mode .modal-content ul {
            color: var(--text-primary-dark);
        }

        .modal-content ul {
            padding-right: 1.5rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        .close-modal {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            margin-top: 1.5rem;
            display: block;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }

        .close-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5);
        }

        /* Info Modal specific styling */
        #info-modal .modal-content {
            max-width: 700px;
        }

        #info-modal h3 {
            font-size: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        #info-modal strong {
            color: var(--primary);
        }

        body.dark-mode #info-modal strong {
            color: var(--primary-light);
        }

        /* Settings Modal */
        #settings-modal .form-group {
            margin-bottom: 1.5rem;
        }

        #settings-modal label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary-light);
        }

        body.dark-mode #settings-modal label {
            color: var(--text-primary-dark);
        }

        #settings-modal input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-primary-light);
            font-family: 'Heebo', sans-serif;
            font-size: 0.938rem;
            transition: all 0.2s ease;
        }

        #settings-modal input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        body.dark-mode #settings-modal input {
            background: var(--bg-dark-card);
            color: var(--text-primary-dark);
            border-color: var(--border-dark);
        }

        body.dark-mode #settings-modal input:focus {
            border-color: var(--primary-light);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-buttons {
                width: 100%;
                justify-content: flex-end;
            }

            .toolbar {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Hide weekend columns - Friday (7th) and Saturday (8th) */
        body.hide-weekend th:nth-child(7),
        body.hide-weekend th:nth-child(8),
        body.hide-weekend td:nth-child(7),
        body.hide-weekend td:nth-child(8) {
            display: none;
        }
    </style>
</head>
<body class="theme-default">
    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-title-section">
                    <h1>
                        <i data-lucide="calendar" style="width: 32px; height: 32px;"></i>
                        מעצב מערכת שעות
                    </h1>
                    <p>צור והדפס את מערכת השעות האישית שלך בקלות</p>
                </div>
                
                <div class="header-buttons">
                    <a href="index.html" class="icon-btn" title="חזרה ללובי">
                        <i data-lucide="layout-grid"></i>
                    </a>
                    <button id="settings-btn" class="icon-btn" title="הגדרות">
                        <i data-lucide="settings"></i>
                    </button>
                    <button id="info-btn" class="icon-btn" title="מידע ועזרה">
                        <i data-lucide="info"></i>
                    </button>
                    <button id="dark-mode-toggle" class="icon-btn" title="מצב כהה/בהיר">
                        <i data-lucide="moon" class="moon-icon"></i>
                        <i data-lucide="sun" class="sun-icon" style="display: none;"></i>
                    </button>
                </div>
            </div>

            <div class="toolbar">
                <button class="btn btn-primary" id="add-row-btn">
                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    הוסף שורה
                </button>
                <button class="btn btn-danger" id="remove-row-btn">
                    <i data-lucide="minus" style="width: 16px; height: 16px;"></i>
                    הסר שורה
                </button>
                <button class="btn" id="toggle-weekend-btn">
                    <i data-lucide="calendar-x" style="width: 16px; height: 16px;"></i>
                    הסתר סופ"ש
                </button>
                <button class="btn" id="clear-btn">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                    נקה הכל
                </button>
                <div class="theme-selector">
                    <label for="theme-select" style="font-weight: 600;">ערכת נושא:</label>
                    <select id="theme-select">
                        <option value="default">ברירת מחדל</option>
                        <option value="1">נושא 1</option>
                        <option value="2">נושא 2</option>
                        <option value="3">נושא 3</option>
                        <option value="minimal">מינימליסטי (ללא צבעים)</option>
                    </select>
                </div>
                <button class="download-btn-special" id="download-btn">
                    <i data-lucide="download" style="width: 20px; height: 20px;"></i>
                    הורד כ-PDF
                </button>
                <button class="btn btn-success" id="download-png-btn">
                    <i data-lucide="image" style="width: 16px; height: 16px;"></i>
                    הורד כתמונה
                </button>
            </div>
        </header>

        <div class="stats">
            <div style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary-light); margin-bottom: 0.5rem;">סה"כ שיעורים במערכת</div>
            <div class="stats-value" id="total-lessons">0</div>
        </div>

        <div class="table-wrapper" id="table-container">
            <table id="schedule-table">
                <thead>
                    <tr>
                        <th>שעה</th>
                        <th>יום א'</th>
                        <th>יום ב'</th>
                        <th>יום ג'</th>
                        <th>יום ד'</th>
                        <th>יום ה'</th>
                        <th>יום ו'</th>
                        <th>יום ש'</th>
                    </tr>
                </thead>
                <tbody id="schedule-tbody">
                    <tr>
                        <th>08:00-09:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>09:00-10:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>10:00-11:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>11:00-12:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>12:00-13:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>13:00-14:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>14:00-15:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                    <tr>
                        <th>15:00-16:00</th>
                        <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>הגדרות מערכת השעות</h2>
            <div class="form-group">
                <label for="student-name">שם הסטודנט:</label>
                <input type="text" id="student-name" placeholder="הזן את שמך">
            </div>
            <div class="form-group">
                <label for="semester-info">סמסטר / שנה:</label>
                <input type="text" id="semester-info" placeholder="לדוגמה: סמסטר א' תשפ״ה">
            </div>
            <button class="close-modal" onclick="closeSettings()">שמור וסגור</button>
        </div>
    </div>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <h2>מדריך למשתמש - מעצב מערכת שעות</h2>
            
            <p>כלי זה נועד לעזור לך ליצור מערכת שעות מסודרת ומעוצבת בקלות. תוכל להוסיף שיעורים, לערוך אותם, ולהוריד את המערכת כקובץ PDF להדפסה.</p>

            <h3>איך להשתמש?</h3>
            <ul>
                <li><strong>הוספת שיעור:</strong> לחץ על תא ריק בטבלה והקלד את פרטי השיעור (שם הקורס, מרצה, כיתה).</li>
                <li><strong>עריכת שיעור:</strong> לחץ על תא עם שיעור קיים כדי לערוך או למחוק אותו.</li>
                <li><strong>הוספת שורות:</strong> השתמש בכפתור "הוסף שורה" להוספת שעות נוספות.</li>
                <li><strong>ערכות נושא:</strong> בחר ערכת צבעים שונה מהתפריט הנפתח.</li>
                <li><strong>הורדה:</strong> לחץ על "הורד כ-PDF" לשמירת המערכת.</li>
            </ul>

            <h3>טיפים שימושיים</h3>
            <ul>
                <li>השתמש במצב כהה לנוחות עבודה בלילה</li>
                <li>ניתן להזין פרטים בשורות מרובות: שם קורס בשורה ראשונה, מרצה בשנייה, וכיתה בשלישית</li>
                <li>כל תא יכול להכיל מידע שונה - התאם לצרכים שלך</li>
                <li>המערכת שומרת את כל הנתונים באופן מקומי בדפדפן</li>
            </ul>

            <h3>פרטיות ואבטחה</h3>
            <p>כל המידע נשמר באופן מקומי בדפדפן שלך בלבד. אין העלאה לשרתים חיצוניים, והפרטיות שלך מובטחת לחלוטין.</p>

            <button class="close-modal" onclick="closeInfo()">סגור</button>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State management
        const colorMap = {}; // Maps keywords to color indices
        let nextColorIndex = 1;
        const maxColors = 8;
        let totalLessons = 0;

        // Function to get consistent color class for a keyword
        function getColorClass(keyword) {
            if (!colorMap[keyword]) {
                colorMap[keyword] = nextColorIndex;
                nextColorIndex = (nextColorIndex % maxColors) + 1;
            }
            return `cell-${colorMap[keyword]}`;
        }

        // Settings
        let studentName = '';
        let semesterInfo = '';

        // Load saved data
        function loadData() {
            const savedData = localStorage.getItem('scheduleData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('schedule-tbody').innerHTML = data.tbody;
                updateTotalLessons();
            }

            const savedSettings = localStorage.getItem('scheduleSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                studentName = settings.studentName || '';
                semesterInfo = settings.semesterInfo || '';
                document.getElementById('student-name').value = studentName;
                document.getElementById('semester-info').value = semesterInfo;
            }

            const savedTheme = localStorage.getItem('scheduleTheme');
            if (savedTheme) {
                document.body.className = savedTheme;
                const themeValue = savedTheme.replace('theme-', '');
                document.getElementById('theme-select').value = themeValue;
            }
        }

        // Save data
        function saveData() {
            const data = {
                tbody: document.getElementById('schedule-tbody').innerHTML
            };
            localStorage.setItem('scheduleData', JSON.stringify(data));
        }

        function saveSettings() {
            const settings = {
                studentName: document.getElementById('student-name').value,
                semesterInfo: document.getElementById('semester-info').value
            };
            studentName = settings.studentName;
            semesterInfo = settings.semesterInfo;
            localStorage.setItem('scheduleSettings', JSON.stringify(settings));
        }

        // Dark mode toggle
        document.getElementById('dark-mode-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const moonIcon = document.querySelector('.moon-icon');
            const sunIcon = document.querySelector('.sun-icon');
            
            if (document.body.classList.contains('dark-mode')) {
                moonIcon.style.display = 'none';
                sunIcon.style.display = 'block';
            } else {
                moonIcon.style.display = 'block';
                sunIcon.style.display = 'none';
            }
            
            lucide.createIcons();
        });

        // Theme selector
        document.getElementById('theme-select').addEventListener('change', (e) => {
            const theme = e.target.value;
            document.body.className = document.body.classList.contains('dark-mode') ? 
                `theme-${theme} dark-mode` : `theme-${theme}`;
            localStorage.setItem('scheduleTheme', `theme-${theme}`);
        });

        // Cell click handler
        document.getElementById('schedule-tbody').addEventListener('click', (e) => {
            const cell = e.target.closest('td');
            const timeCell = e.target.closest('th');
            
            // Handle time cell editing
            if (timeCell && timeCell.parentElement.parentElement.tagName === 'TBODY') {
                const currentTime = timeCell.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentTime;
                input.style.cssText = 'width: 100%; padding: 8px; border: 2px solid var(--primary); border-radius: 8px; font-size: 14px; text-align: center;';
                
                timeCell.textContent = '';
                timeCell.appendChild(input);
                input.focus();
                input.select();
                
                const finishTimeEdit = () => {
                    const newTime = input.value.trim();
                    timeCell.textContent = newTime || currentTime;
                    saveData();
                };
                
                input.addEventListener('blur', finishTimeEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    } else if (e.key === 'Escape') {
                        timeCell.textContent = currentTime;
                    }
                });
                return;
            }
            
            if (!cell) return;

            if (cell.querySelector('.content-cell')) {
                // Edit mode
                if (confirm('האם ברצונך למחוק את השיעור הזה?')) {
                    cell.innerHTML = '';
                    saveData();
                    updateTotalLessons();
                }
            } else {
                // Add mode
                const textarea = document.createElement('textarea');
                textarea.placeholder = 'הקלד פרטי שיעור\n(לדוגמה: שם הקורס, מרצה, כיתה)';
                cell.appendChild(textarea);
                textarea.focus();

                const finishEditing = () => {
                    const content = textarea.value.trim();
                    cell.innerHTML = '';

                    if (content) {
                        const lines = content.split('\n').filter(l => l.trim());
                        const firstWord = lines[0].split(' ')[0].toLowerCase();
                        const colorClass = getColorClass(firstWord);
                        
                        const contentCell = document.createElement('div');
                        contentCell.className = `content-cell ${colorClass}`;
                        contentCell.dataset.keyword = firstWord;

                        if (lines.length > 0) {
                            const title = document.createElement('div');
                            title.className = 'cell-title';
                            title.textContent = lines[0];
                            contentCell.appendChild(title);
                        }

                        if (lines.length > 1) {
                            const subtitle = document.createElement('div');
                            subtitle.className = 'cell-subtitle';
                            subtitle.textContent = lines[1];
                            contentCell.appendChild(subtitle);
                        }

                        if (lines.length > 2) {
                            const details = document.createElement('div');
                            details.className = 'cell-details';
                            details.textContent = lines.slice(2).join(' • ');
                            contentCell.appendChild(details);
                        }

                        cell.appendChild(contentCell);
                        saveData();
                        updateTotalLessons();
                    }
                };

                textarea.addEventListener('blur', finishEditing);

                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        textarea.blur();
                    }
                });
            }
        });

        // Add row
        document.getElementById('add-row-btn').addEventListener('click', () => {
            const tbody = document.getElementById('schedule-tbody');
            const lastRow = tbody.querySelector('tr:last-child');
            const lastTime = lastRow.querySelector('th').textContent;
            
            const [startHour] = lastTime.split('-')[0].split(':').map(Number);
            const newStartHour = startHour + 1;
            const newEndHour = newStartHour + 1;
            const newTimeString = `${String(newStartHour).padStart(2, '0')}:00-${String(newEndHour).padStart(2, '0')}:00`;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <th>${newTimeString}</th>
                <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
            `;
            tbody.appendChild(newRow);
            saveData();
        });

        // Remove row
        document.getElementById('remove-row-btn').addEventListener('click', () => {
            const tbody = document.getElementById('schedule-tbody');
            const rows = tbody.querySelectorAll('tr');
            if (rows.length > 1) {
                rows[rows.length - 1].remove();
                saveData();
                updateTotalLessons();
            }
        });

        // Clear all
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('האם אתה בטוח שברצונך למחוק את כל המערכת?')) {
                const cells = document.querySelectorAll('#schedule-tbody td');
                cells.forEach(cell => cell.innerHTML = '');
                Object.keys(colorMap).forEach(key => delete colorMap[key]);
                nextColorIndex = 1;
                saveData();
                updateTotalLessons();
            }
        });

        // Toggle weekend columns
        let weekendHidden = false;
        document.getElementById('toggle-weekend-btn').addEventListener('click', () => {
            weekendHidden = !weekendHidden;
            document.body.classList.toggle('hide-weekend', weekendHidden);
            
            const btn = document.getElementById('toggle-weekend-btn');
            if (weekendHidden) {
                btn.innerHTML = '<i data-lucide="calendar-check" style="width: 16px; height: 16px;"></i> הצג סופ"ש';
            } else {
                btn.innerHTML = '<i data-lucide="calendar-x" style="width: 16px; height: 16px;"></i> הסתר סופ"ש';
            }
            lucide.createIcons();
            
            localStorage.setItem('weekendHidden', weekendHidden);
        });

        // Update total lessons counter
        function updateTotalLessons() {
            const filledCells = document.querySelectorAll('#schedule-tbody td .content-cell');
            totalLessons = filledCells.length;
            document.getElementById('total-lessons').textContent = totalLessons;
        }

        // Settings modal
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('active');
        });

        function closeSettings() {
            saveSettings();
            document.getElementById('settings-modal').classList.remove('active');
        }

        // Info modal
        document.getElementById('info-btn').addEventListener('click', () => {
            document.getElementById('info-modal').classList.add('active');
        });

        function closeInfo() {
            document.getElementById('info-modal').classList.remove('active');
        }

        // Close modals on backdrop click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Download as PDF - NEW APPROACH: Build clean HTML without CSS classes
        document.getElementById('download-btn').addEventListener('click', async () => {
            const button = document.getElementById('download-btn');
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" style="width: 20px; height: 20px; animation: spin 1s linear infinite;"></i> מכין PDF...';
            lucide.createIcons();

            try {
                // Define SUPER STRONG colors
                const colorMaps = {
                    'theme-default': {
                        'cell-1': '#DC2626',
                        'cell-2': '#1D4ED8',
                        'cell-3': '#0891B2',
                        'cell-4': '#047857',
                        'cell-5': '#D97706',
                        'cell-6': '#EA580C',
                        'cell-7': '#7C3AED',
                        'cell-8': '#DB2777'
                    },
                    'theme-1': {
                        'cell-1': '#B91C1C',
                        'cell-2': '#EA580C',
                        'cell-3': '#047857',
                        'cell-4': '#0284C7',
                        'cell-5': '#1E3A8A',
                        'cell-6': '#DB2777',
                        'cell-7': '#D97706',
                        'cell-8': '#075985'
                    },
                    'theme-2': {
                        'cell-1': '#A855F7',
                        'cell-2': '#FB7185',
                        'cell-3': '#FB923C',
                        'cell-4': '#F472B6',
                        'cell-5': '#C4B5FD',
                        'cell-6': '#F87171',
                        'cell-7': '#9F1239',
                        'cell-8': '#8B5CF6'
                    },
                    'theme-3': {
                        'cell-1': '#BE123C',
                        'cell-2': '#EA580C',
                        'cell-3': '#D97706',
                        'cell-4': '#9333EA',
                        'cell-5': '#1D4ED8',
                        'cell-6': '#0D9488',
                        'cell-7': '#DB2777',
                        'cell-8': '#EA580C'
                    }
                };
                
                const currentTheme = document.body.className.match(/theme-\w+/)?.[0] || 'theme-default';
                const isDark = document.body.classList.contains('dark-mode');
                const colors = colorMaps[currentTheme] || colorMaps['theme-default'];
                
                // Build completely NEW table from scratch with inline styles only
                const printContainer = document.createElement('div');
                printContainer.style.cssText = `
                    padding: 40px;
                    background: white;
                    width: 1400px;
                    font-family: Arial, sans-serif;
                    position: absolute;
                    left: -99999px;
                    top: 0;
                `;
                
                // Add header
                if (studentName || semesterInfo) {
                    const header = document.createElement('div');
                    header.style.cssText = 'text-align: center; margin-bottom: 30px;';
                    
                    if (studentName) {
                        const nameEl = document.createElement('h2');
                        nameEl.textContent = studentName;
                        nameEl.style.cssText = 'margin: 0 0 10px 0; font-size: 36px; font-weight: bold; color: #1D4ED8;';
                        header.appendChild(nameEl);
                    }
                    
                    if (semesterInfo) {
                        const semEl = document.createElement('p');
                        semEl.textContent = semesterInfo;
                        semEl.style.cssText = 'margin: 0; font-size: 24px; color: #6B7280; font-weight: 600;';
                        header.appendChild(semEl);
                    }
                    
                    printContainer.appendChild(header);
                }
                
                // Create new table
                const newTable = document.createElement('table');
                newTable.style.cssText = `
                    width: 100%;
                    border-collapse: separate;
                    border-spacing: 8px;
                    background: white;
                `;
                
                // Clone thead
                const originalTable = document.getElementById('schedule-table');
                const thead = document.createElement('thead');
                const headerRow = originalTable.querySelector('thead tr');
                const newHeaderRow = document.createElement('tr');
                
                headerRow.querySelectorAll('th').forEach(th => {
                    const newTh = document.createElement('th');
                    newTh.textContent = th.textContent;
                    newTh.style.cssText = `
                        padding: 16px;
                        background: #1D4ED8;
                        color: white;
                        font-weight: bold;
                        font-size: 18px;
                        border-radius: 8px;
                        text-align: center;
                    `;
                    newHeaderRow.appendChild(newTh);
                });
                thead.appendChild(newHeaderRow);
                newTable.appendChild(thead);
                
                // Clone tbody with INLINE styles
                const tbody = document.createElement('tbody');
                const originalRows = originalTable.querySelectorAll('tbody tr');
                
                originalRows.forEach(row => {
                    const newRow = document.createElement('tr');
                    
                    // Time cell
                    const timeCell = row.querySelector('th');
                    const newTimeCell = document.createElement('th');
                    newTimeCell.textContent = timeCell.textContent;
                    newTimeCell.style.cssText = `
                        padding: 16px;
                        background: #F3F4F6;
                        font-weight: bold;
                        font-size: 16px;
                        border-radius: 8px;
                        text-align: center;
                        min-width: 120px;
                    `;
                    newRow.appendChild(newTimeCell);
                    
                    // Data cells
                    row.querySelectorAll('td').forEach(cell => {
                        const newCell = document.createElement('td');
                        newCell.style.cssText = `
                            padding: 8px;
                            min-width: 150px;
                            min-height: 80px;
                            vertical-align: middle;
                        `;
                        
                        const contentCell = cell.querySelector('.content-cell');
                        if (contentCell) {
                            // Get the color class
                            const cellClass = Array.from(contentCell.classList).find(cls => cls.startsWith('cell-'));
                            const bgColor = cellClass ? colors[cellClass] : '#1D4ED8';
                            
                            // Create content div with SOLID color
                            const contentDiv = document.createElement('div');
                            contentDiv.style.cssText = `
                                background: ${bgColor};
                                color: white;
                                padding: 12px;
                                border-radius: 10px;
                                min-height: 70px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            `;
                            
                            // Copy text content
                            const title = contentCell.querySelector('.cell-title');
                            if (title) {
                                const titleDiv = document.createElement('div');
                                titleDiv.textContent = title.textContent;
                                titleDiv.style.cssText = 'font-size: 16px; margin-bottom: 4px; font-weight: bold;';
                                contentDiv.appendChild(titleDiv);
                            }
                            
                            const subtitle = contentCell.querySelector('.cell-subtitle');
                            if (subtitle) {
                                const subtitleDiv = document.createElement('div');
                                subtitleDiv.textContent = subtitle.textContent;
                                subtitleDiv.style.cssText = 'font-size: 13px; margin-bottom: 2px;';
                                contentDiv.appendChild(subtitleDiv);
                            }
                            
                            const details = contentCell.querySelector('.cell-details');
                            if (details) {
                                const detailsDiv = document.createElement('div');
                                detailsDiv.textContent = details.textContent;
                                detailsDiv.style.cssText = 'font-size: 11px; opacity: 0.9;';
                                contentDiv.appendChild(detailsDiv);
                            }
                            
                            newCell.appendChild(contentDiv);
                        }
                        
                        newRow.appendChild(newCell);
                    });
                    
                    tbody.appendChild(newRow);
                });
                
                newTable.appendChild(tbody);
                printContainer.appendChild(newTable);
                document.body.appendChild(printContainer);
                
                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Screenshot with highest quality
                const canvas = await html2canvas(printContainer, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: false
                });

                document.body.removeChild(printContainer);

                // Convert to PDF
                const imgData = canvas.toDataURL('image/png', 1.0);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pdfWidth - 20;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                let yPos = 10;
                if (imgHeight > pdfHeight - 20) {
                    const scale = (pdfHeight - 20) / imgHeight;
                    pdf.addImage(imgData, 'PNG', 10, yPos, imgWidth * scale, imgHeight * scale);
                } else {
                    pdf.addImage(imgData, 'PNG', 10, yPos, imgWidth, imgHeight);
                }

                pdf.save(`מערכת_שעות_${new Date().toISOString().split('T')[0]}.pdf`);

            } catch (error) {
                alert('אירעה שגיאה בהורדת ה-PDF. אנא נסה שוב.');
                console.error(error);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="download" style="width: 20px; height: 20px;"></i> הורד כ-PDF';
                lucide.createIcons();
            }
        });

        // Download as PNG - Same new approach
        document.getElementById('download-png-btn').addEventListener('click', async () => {
            const button = document.getElementById('download-png-btn');
            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> מכין תמונה...';
            lucide.createIcons();

            try {
                // Same color maps
                const colorMaps = {
                    'theme-default': {
                        'cell-1': '#DC2626',
                        'cell-2': '#1D4ED8',
                        'cell-3': '#0891B2',
                        'cell-4': '#047857',
                        'cell-5': '#D97706',
                        'cell-6': '#EA580C',
                        'cell-7': '#7C3AED',
                        'cell-8': '#DB2777'
                    },
                    'theme-1': {
                        'cell-1': '#B91C1C',
                        'cell-2': '#EA580C',
                        'cell-3': '#047857',
                        'cell-4': '#0284C7',
                        'cell-5': '#1E3A8A',
                        'cell-6': '#DB2777',
                        'cell-7': '#D97706',
                        'cell-8': '#075985'
                    },
                    'theme-2': {
                        'cell-1': '#A855F7',
                        'cell-2': '#FB7185',
                        'cell-3': '#FB923C',
                        'cell-4': '#F472B6',
                        'cell-5': '#C4B5FD',
                        'cell-6': '#F87171',
                        'cell-7': '#9F1239',
                        'cell-8': '#8B5CF6'
                    },
                    'theme-3': {
                        'cell-1': '#BE123C',
                        'cell-2': '#EA580C',
                        'cell-3': '#D97706',
                        'cell-4': '#9333EA',
                        'cell-5': '#1D4ED8',
                        'cell-6': '#0D9488',
                        'cell-7': '#DB2777',
                        'cell-8': '#EA580C'
                    }
                };
                
                const currentTheme = document.body.className.match(/theme-\w+/)?.[0] || 'theme-default';
                const colors = colorMaps[currentTheme] || colorMaps['theme-default'];
                
                // Build NEW table with inline styles
                const printContainer = document.createElement('div');
                printContainer.style.cssText = `
                    padding: 40px;
                    background: white;
                    width: fit-content;
                    font-family: Arial, sans-serif;
                    position: absolute;
                    left: -99999px;
                    top: 0;
                `;
                
                // Add header
                if (studentName || semesterInfo) {
                    const header = document.createElement('div');
                    header.style.cssText = 'text-align: center; margin-bottom: 30px;';
                    
                    if (studentName) {
                        const nameEl = document.createElement('h2');
                        nameEl.textContent = studentName;
                        nameEl.style.cssText = 'margin: 0 0 10px 0; font-size: 40px; font-weight: bold; color: #1D4ED8;';
                        header.appendChild(nameEl);
                    }
                    
                    if (semesterInfo) {
                        const semEl = document.createElement('p');
                        semEl.textContent = semesterInfo;
                        semEl.style.cssText = 'margin: 0; font-size: 28px; color: #6B7280; font-weight: 600;';
                        header.appendChild(semEl);
                    }
                    
                    printContainer.appendChild(header);
                }
                
                // Create new table
                const newTable = document.createElement('table');
                newTable.style.cssText = `
                    border-collapse: separate;
                    border-spacing: 10px;
                    background: white;
                `;
                
                // Clone thead
                const originalTable = document.getElementById('schedule-table');
                const thead = document.createElement('thead');
                const headerRow = originalTable.querySelector('thead tr');
                const newHeaderRow = document.createElement('tr');
                
                headerRow.querySelectorAll('th').forEach(th => {
                    const newTh = document.createElement('th');
                    newTh.textContent = th.textContent;
                    newTh.style.cssText = `
                        padding: 18px;
                        background: #1D4ED8;
                        color: white;
                        font-weight: bold;
                        font-size: 20px;
                        border-radius: 10px;
                        text-align: center;
                    `;
                    newHeaderRow.appendChild(newTh);
                });
                thead.appendChild(newHeaderRow);
                newTable.appendChild(thead);
                
                // Clone tbody
                const tbody = document.createElement('tbody');
                const originalRows = originalTable.querySelectorAll('tbody tr');
                
                originalRows.forEach(row => {
                    const newRow = document.createElement('tr');
                    
                    // Time cell
                    const timeCell = row.querySelector('th');
                    const newTimeCell = document.createElement('th');
                    newTimeCell.textContent = timeCell.textContent;
                    newTimeCell.style.cssText = `
                        padding: 18px;
                        background: #F3F4F6;
                        font-weight: bold;
                        font-size: 18px;
                        border-radius: 10px;
                        text-align: center;
                        min-width: 140px;
                    `;
                    newRow.appendChild(newTimeCell);
                    
                    // Data cells
                    row.querySelectorAll('td').forEach(cell => {
                        const newCell = document.createElement('td');
                        newCell.style.cssText = `
                            padding: 10px;
                            min-width: 160px;
                            min-height: 90px;
                            vertical-align: middle;
                        `;
                        
                        const contentCell = cell.querySelector('.content-cell');
                        if (contentCell) {
                            const cellClass = Array.from(contentCell.classList).find(cls => cls.startsWith('cell-'));
                            const bgColor = cellClass ? colors[cellClass] : '#1D4ED8';
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.style.cssText = `
                                background: ${bgColor};
                                color: white;
                                padding: 14px;
                                border-radius: 12px;
                                min-height: 80px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                            `;
                            
                            const title = contentCell.querySelector('.cell-title');
                            if (title) {
                                const titleDiv = document.createElement('div');
                                titleDiv.textContent = title.textContent;
                                titleDiv.style.cssText = 'font-size: 18px; margin-bottom: 5px; font-weight: bold;';
                                contentDiv.appendChild(titleDiv);
                            }
                            
                            const subtitle = contentCell.querySelector('.cell-subtitle');
                            if (subtitle) {
                                const subtitleDiv = document.createElement('div');
                                subtitleDiv.textContent = subtitle.textContent;
                                subtitleDiv.style.cssText = 'font-size: 15px; margin-bottom: 3px;';
                                contentDiv.appendChild(subtitleDiv);
                            }
                            
                            const details = contentCell.querySelector('.cell-details');
                            if (details) {
                                const detailsDiv = document.createElement('div');
                                detailsDiv.textContent = details.textContent;
                                detailsDiv.style.cssText = 'font-size: 13px; opacity: 0.9;';
                                contentDiv.appendChild(detailsDiv);
                            }
                            
                            newCell.appendChild(contentDiv);
                        }
                        
                        newRow.appendChild(newCell);
                    });
                    
                    tbody.appendChild(newRow);
                });
                
                newTable.appendChild(tbody);
                printContainer.appendChild(newTable);
                document.body.appendChild(printContainer);
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const canvas = await html2canvas(printContainer, {
                    scale: 3,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: false
                });

                document.body.removeChild(printContainer);

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `מערכת_שעות_${new Date().toISOString().split('T')[0]}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                }, 'image/png', 1.0);

            } catch (error) {
                alert('אירעה שגיאה בהורדת התמונה. אנא נסה שוב.');
                console.error(error);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="image" style="width: 16px; height: 16px;"></i> הורד כתמונה';
                lucide.createIcons();
            }
        });

        // Initialize
        loadData();
        updateTotalLessons();
        
        // Load weekend hidden state
        const savedWeekendState = localStorage.getItem('weekendHidden');
        if (savedWeekendState === 'true') {
            weekendHidden = true;
            document.body.classList.add('hide-weekend');
            const btn = document.getElementById('toggle-weekend-btn');
            btn.innerHTML = '<i data-lucide="calendar-check" style="width: 16px; height: 16px;"></i> הצג סופ"ש';
            lucide.createIcons();
        }
    </script>
</body>
</html>