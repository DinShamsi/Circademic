<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link rel="icon" href="favicon2.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הזנת קורסים</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&family=Rubik:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Design System Variables (זהה) */
        :root {
            --primary: #3B82F6; --primary-light: #60A5FA; --primary-dark: #2563EB;
            --secondary: #8B5CF6; --secondary-light: #A78BFA; --secondary-dark: #7C3AED;
            --accent: #F59E0B; --accent-light: #FBBF24; --accent-dark: #D97706;
            --success: #10B981; --success-light: #34D399; --success-dark: #059669;
            --bg-light: #F9FAFB; --bg-lighter: #FFFFFF; --bg-dark: #0F172A;
            --bg-darker: #030712; --bg-dark-card: #1E293B;
            --text-primary-light: #111827; --text-secondary-light: #6B7280;
            --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF;
            --border-light: #E5E7EB; --border-dark: #374151;
            --spacing-xs: 0.25rem; --spacing-sm: 0.5rem; --spacing-md: 1rem;
            --spacing-lg: 1.5rem; --spacing-xl: 2rem;
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px; --radius-xl: 20px;
        }

        /* שאר ה-CSS נשאר זהה לקובץ המקורי */
        body { 
            font-family: 'Heebo', sans-serif;
            background: var(--bg-light);
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.dark { background: var(--bg-dark); }
        h1, h2, h3, h4, h5, h6 { font-family: 'Rubik', sans-serif; font-weight: 700; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: var(--bg-dark-card); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; border: 2px solid transparent; background-clip: padding-box; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark)); background-clip: padding-box; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* סגנונות חדשים עבור טעינה ומצב נסתר */
        .hidden { display: none !important; }
        
        #loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            gap: var(--spacing-md);
        }
        .loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid var(--border-light);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        body.dark .loader {
             border: 5px solid var(--border-dark);
             border-top-color: var(--primary-light);
        }

        /* שאר ה-CSS זהה */
        .stat-card { background: white; border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeInUp 0.5s ease-out; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1); border-color: rgba(59, 130, 246, 0.3); }
        .dark .stat-card { background: var(--bg-dark-card); border-color: rgba(59, 130, 246, 0.2); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }
        .dark .stat-card:hover { box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4); }
        .badge-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 700; display: inline-block; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3); }
        .badge-accent { background: linear-gradient(135deg, var(--accent), #EF4444); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 700; display: inline-block; box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5); }
        .btn-primary:active { transform: translateY(0); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 92, 246, 0.5); }
        .btn-accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(245, 158, 11, 0.4); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .btn-accent:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.5); }
        .btn-success { background: linear-gradient(135deg, var(--success), var(--success-dark)); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; border: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4); display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5); }
        .icon-btn { width: 2.75rem; height: 2.75rem; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; background: rgba(59, 130, 246, 0.1); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; border: none; text-decoration: none; }
        .icon-btn:hover { background: rgba(59, 130, 246, 0.2); transform: scale(1.1); }
        .dark .icon-btn { background: rgba(59, 130, 246, 0.15); }
        .dark .icon-btn:hover { background: rgba(59, 130, 246, 0.25); }
        input[type="text"], input[type="number"], input[type="search"], select, textarea { padding: 0.75rem 1rem; border: 2px solid var(--border-light); border-radius: var(--radius-md); background: var(--bg-light); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-size: 0.938rem; font-family: 'Heebo', sans-serif; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .dark input[type="text"], .dark input[type="number"], .dark input[type="search"], .dark select, .dark textarea { background: var(--bg-dark-card); border-color: var(--border-dark); color: var(--text-primary-dark); }
        .dark input:focus, .dark select:focus, .dark textarea:focus { background: #1E293B; border-color: var(--primary-light); }
        .progress-bar-container { width: 100%; height: 0.75rem; background: var(--border-light); border-radius: 9999px; overflow: hidden; position: relative; }
        .dark .progress-bar-container { background: var(--bg-dark-card); }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 9999px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .modal-backdrop { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
        .modal-container { background: white; border-radius: var(--radius-xl); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: fadeInUp 0.3s ease-out; }
        .dark .modal-container { background: var(--bg-dark-card); }
        .sortable { cursor: pointer; user-select: none; transition: color 0.2s ease; }
        .sortable:hover { color: var(--primary); }
        table tbody tr { transition: background-color 0.2s ease; }
        table tbody tr:hover { background-color: rgba(59, 130, 246, 0.05); }
        .dark table tbody tr:hover { background-color: rgba(59, 130, 246, 0.1); }
        .header-title { background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-number-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-number-accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-number-success { background: linear-gradient(135deg, var(--success), var(--success-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .badge-moed-a { background: linear-gradient(135deg, var(--primary-light), var(--primary)); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-moed-b { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-category { background: rgba(139, 92, 246, 0.1); color: var(--secondary); padding: 0.375rem 0.875rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .dark .badge-category { background: rgba(139, 92, 246, 0.2); color: var(--secondary-light); }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">

    <div id="loading-container" class="bg-gray-100 dark:bg-gray-900">
        <div class="loader"></div>
        <p class="text-gray-600 dark:text-gray-400">מאמת נתונים...</p>
    </div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold header-title mb-2" id="header-title">הזנת נתוני קורסים</h1>
                <p class="text-gray-600 dark:text-gray-400 text-lg" id="header-subtitle">ברוך הבא!</p>
            </div>
            <div class="flex items-center gap-2">
                <a href="/" class="icon-btn text-gray-600 dark:text-gray-300" title="חזרה לדף הבית">
                    <i data-lucide="layout-grid"></i>
                </a>
                <button id="settings-btn" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i data-lucide="settings"></i>
                </button>
                <button id="dark-mode-toggle" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i data-lucide="moon" class="block dark:hidden"></i>
                    <i data-lucide="sun" class="hidden dark:block"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 gap-6">
            
            <div class="flex flex-col gap-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="stat-card text-center">
                        <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">ממוצע משוקלל</h3>
                        <p id="avg-grade" class="text-4xl font-bold stat-number-primary mt-1">0.00</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">סה"כ נ"ז</h3>
                        <p id="total-credits" class="text-4xl font-bold stat-number-accent mt-1">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">ציון שיא</h3>
                        <p id="highest-grade" class="text-lg font-bold stat-number-success mt-1 truncate">-</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-sm font-semibold text-gray-600 dark:text-gray-400 mb-2">ציון נמוך</h3>
                        <p id="lowest-grade" class="text-lg font-bold text-red-500 dark:text-red-400 mt-1 truncate">-</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 dark:text-gray-200 text-lg">התקדמות בתואר</h3>
                        <span id="degree-progress-text" class="text-sm font-bold badge-primary">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="degree-progress-bar" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div id="form-container" class="stat-card">
                    <h2 id="form-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6">הוספת קורס חדש</h2>
                    <form id="course-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="courseName" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">שם הקורס</label>
                            <input type="text" id="courseName" placeholder="לדוגמה: מבוא למדעי המחשב" class="w-full">
                        </div>
                        <div>
                            <label for="credits" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">נ"ז</label>
                            <input type="number" id="credits" step="0.5" min="0" placeholder="3.5" class="w-full">
                        </div>
                        <div>
                            <label for="grade" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ציון</label>
                            <input type="number" id="grade" min="0" max="100" placeholder="88" class="w-full">
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">סמסטר</label>
                            <input type="number" id="semester" min="1" placeholder="1" class="w-full">
                        </div>
                        <div>
                            <label for="courseCategory" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">קטגוריה</label>
                            <select id="courseCategory" class="w-full">
                            </select>
                        </div>
                        <div class="md:col-span-2 flex items-center gap-x-6 gap-y-2 flex-wrap">
                            <div class="flex items-center pt-2">
                                <input id="isMoedB" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="isMoedB" class="mr-2 text-sm font-medium text-gray-900 dark:text-gray-300">מועד ב'</label>
                            </div>
                            <div class="flex items-center pt-2">
                                <input id="isPassFail" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <label for="isPassFail" class="mr-2 text-sm font-medium text-gray-900 dark:text-gray-300">ציון בינארי</label>
                            </div>
                        </div>
                        <div class="md:col-span-2 flex gap-4 mt-2">
                            <button type="submit" id="submit-btn" class="btn-primary flex-1">הוסף קורס</button>
                            <button type="button" id="cancel-edit-btn" class="hidden btn-secondary flex-1 bg-gray-500 hover:bg-gray-600">ביטול עריכה</button>
                        </div>
                    </form>
                </div>

                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">רשימת קורסים</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button id="what-if-btn" class="btn-accent">
                                <i data-lucide="calculator" class="w-4 h-4"></i>
                                מחשבון "מה אם"
                            </button>
                            <button id="import-csv-btn" class="btn-secondary">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                ייבוא מ-CSV
                            </button>
                            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                            <button id="export-csv-btn" class="btn-success">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                ייצוא ל-CSV
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="search" id="search-input" placeholder="חפש קורס..." class="md:col-span-2 w-full">
                        <select id="filter-semester" class="w-full">
                            <option value="all">כל הסמסטרים</option>
                        </select>
                        <select id="filter-category" class="w-full">
                            <option value="all">כל הקטגוריות</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto max-h-96">
                        <table class="w-full text-sm">
                            <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-800 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-right sortable text-gray-700 dark:text-gray-300" data-sort="name">קורס <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable text-gray-700 dark:text-gray-300" data-sort="category">קטגוריה <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable text-gray-700 dark:text-gray-300" data-sort="semester">סמסטר <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable text-gray-700 dark:text-gray-300" data-sort="credits">נ"ז <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right sortable text-gray-700 dark:text-gray-300" data-sort="grade">ציון <i data-lucide="arrow-down-up" class="inline-block w-3 h-3"></i></th>
                                    <th scope="col" class="px-4 py-3 text-right text-gray-700 dark:text-gray-300">מועד</th>
                                    <th scope="col" class="px-4 py-3 text-center text-gray-700 dark:text-gray-300">פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="course-list" class="divide-y divide-gray-200 dark:divide-gray-700 text-gray-600 dark:text-gray-400">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            </div>

        <div id="settings-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
            <div class="modal-container p-8 w-full max-w-md m-4 transform transition-all">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">הגדרות</h2>
                    <button id="close-settings-btn" class="icon-btn">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <form id="settings-form" class="space-y-4">
                    <div>
                        <label for="userName" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">שם הסטודנט</label>
                        <input type="text" id="userName" placeholder="סאוסר" class="w-full">
                    </div>
                    <div>
                        <label for="institution" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">מוסד לימודים</label>
                        <input type="text" id="institution" placeholder="האוניברסיטה העברית" class="w-full">
                    </div>
                    <div>
                        <label for="major" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">תחום לימוד</label>
                        <input type="text" id="major" placeholder="הנדסת מכונות" class="w-full">
                    </div>
                    <div>
                        <label for="requiredCredits" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">סה"כ נ"ז לתואר</label>
                        <input type="number" id="requiredCredits" min="1" placeholder="160" class="w-full">
                    </div>
                    <div>
                        <label for="userCategories" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">קטגוריות קורסים (מופרד בפסיק)</label>
                        <input type="text" id="userCategories" placeholder="חובה, בחירה, כללי, ספורט, התמחות" class="w-full">
                    </div>
                    <div class="pt-4 flex justify-between items-center gap-4">
                        <button type="submit" class="btn-primary flex-1">שמור שינויים</button>
                        <button type="button" id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition-all">מחק הכל</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="confirm-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
            <div class="modal-container p-6 w-full max-w-sm text-center">
                <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 text-red-500"></i>
                <h3 class="text-lg font-bold text-gray-900 dark:text-gray-200 mt-4">אישור מחיקה</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו אינה הפיכה.</p>
                <div class="mt-6 flex justify-center gap-4">
                    <button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-xl hover:bg-red-700 font-semibold transition-all">כן, מחק הכל</button>
                    <button id="cancel-delete-btn" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-6 py-2 rounded-xl hover:bg-gray-400 dark:hover:bg-gray-500 font-semibold transition-all">ביטול</button>
                </div>
            </div>
        </div>

        <div id="what-if-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
             <div class="modal-container p-8 w-full max-w-md m-4 transform transition-all">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200">מחשבון ממוצע עתידי</h2>
                    <button id="close-what-if-btn" class="icon-btn">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="space-y-4">
                    <p class="text-gray-600 dark:text-gray-400 text-sm">הזן ציונים ונקודות זכות של קורסים עתידיים כדי לראות איך הממוצע המשוקלל שלך יושפע. הנתונים כאן לא נשמרים.</p>
                    <div id="what-if-courses" class="space-y-2">
                    </div>
                    <button id="add-what-if-course-btn" class="w-full text-sm bg-gray-200 dark:bg-gray-700 p-2 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition-all font-semibold">הוסף קורס נוסף</button>
                    <hr class="my-4 border-gray-200 dark:border-gray-700">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-400">הממוצע החדש שלך יהיה:</h3>
                        <p id="what-if-result" class="text-5xl font-bold badge-primary mt-2 inline-block">0.00</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">מבוסס על <span id="what-if-credits-info"></span></p>
                    </div>
                </div>
            </div>
        </div>

        </div>


    <script>
    // === בלוק אתחול Firebase והגדרות ===
    const firebaseConfig = {
      apiKey: "AIzaSyDj1V85FXrcZ8Tg1kezkTsO50bgMOLcnPk",
      authDomain: "circademic-582dc.firebaseapp.com",
      projectId: "circademic-582dc",
      storageBucket: "circademic-582dc.firebasestorage.app",
      messagingSenderId: "296566462689",
      appId: "1:296566462689:web:d23a6f74078de2332bbfa0",
      measurementId: "G-SPD143KGDK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // === משתנים גלובליים לניהול ===
    let currentUser = null;
    let academicDataRef = null; 
    
    // === State גלובלי ===
    let state = {
        courses: [],
        userInfo: {
            name: '',
            institution: '',
            major: '',
            requiredCredits: 120,
            categories: ['חובה', 'בחירה', 'כללי', 'ספורט']
        },
        editMode: { active: false, courseId: null },
        darkMode: false,
        viewState: {
            searchTerm: '',
            filterSemester: 'all',
            filterCategory: 'all',
            sortBy: 'semester',
            sortOrder: 'asc'
        }
    };

    // === תיקון: הצהרה על משתני DOM גלובליים ===
    let loadingContainer, appContainer, courseForm, courseListEl, formTitle, submitBtn, 
        cancelEditBtn, courseNameInput, creditsInput, gradeInput, semesterInput, 
        isMoedBInput, isPassFailInput, courseCategoryInput, avgGradeEl, totalCreditsEl, 
        highestGradeEl, lowestGradeEl, degreeProgressText, degreeProgressBar, 
        settingsModal, settingsForm, // מחיקת: semesterAveragesEl, categoryAveragesEl
        userNameInput, institutionInput, majorInput, requiredCreditsInput, 
        userCategoriesInput, headerTitle, headerSubtitle, confirmModal, 
        whatIfModal, whatIfCoursesContainer, whatIfResultEl, whatIfCreditsInfoEl, 
        searchInput, filterSemesterEl, filterCategoryEl, csvFileInput, 
        darkModeToggle;

    // Charts
    // ===== מחיקה: let moedChart, trendChart; =====
    const chartDefaultFont = { family: "'Heebo', sans-serif", size: 12 };
    
    
    // --- === Auth State Observer (ה-"שומר סף") === ---
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            academicDataRef = db.collection('academicData').doc(currentUser.uid);
            
            // נחכה שה-DOM יהיה מוכן לפני שנאתחל את האפליקציה
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initApp);
            } else {
                initApp(); // ה-DOM כבר טעון
            }
            
        } else {
            // החזר אותו לדף ההתחברות
            window.location.href = 'index.html';
        }
    });

    // --- === פונקציות שמירת וטעינת נתונים (משוכתבות) === ---
    
    async function saveState() {
        if (!academicDataRef) return; 
        
        const dataToSave = {
            courses: state.courses,
            userInfo: state.userInfo
        };
        
        try {
            await academicDataRef.set(dataToSave);
            // console.log("Data saved to Firestore"); // (טוב לדיבאגינג)
        } catch (error) {
            // === תיקון: טיפול שקט בשגיאות שמירה ===
            console.error("Error saving data to Firestore: ", error);
            // לא נקפיץ alert כדי לא להפריע למשתמש
        }
    }

    async function loadState() {
        if (!academicDataRef) return;

        try {
            const doc = await academicDataRef.get();
            
            if (doc.exists) {
                const loadedData = doc.data();
                state.courses = loadedData.courses || [];
                state.userInfo = { ...state.userInfo, ...loadedData.userInfo }; 
            } else {
                console.log("No data found for this user. Creating new profile.");
                // אין צורך לעשות כלום, state נשאר ברירת מחדל
                // ניצור מסמך בשמירה הראשונה
                await saveState(); // ניצור מסמך ריק בפעם הראשונה
            }
        } catch (error) {
            // === תיקון: טיפול בשגיאת טעינה ===
            console.error("Error loading data from Firestore: ", error);
            // זו השגיאה שקיבלת. היא נגרמת מחוקי אבטחה שגויים.
            alert("שגיאה בטעינת הנתונים. ודא שהגדרת את חוקי האבטחה ב-Firestore.");
        }
    }

    // --- === פונקציות ליבה (זהות) === ---
    
    function updateDashboard() {
        renderTable();
        calculateAndRenderSummary();
        // ===== מחיקה: renderSemesterAverages(); =====
        // ===== מחיקה: renderCategoryAverages(); =====
        // ===== מחיקה: renderCharts(); =====
        updateHeader();
        populateFilterOptions();
        
        // כל עדכון דשבורד גורר שמירה בענן
        saveState(); 
    }

    // (כל שאר פונקציות הרנדור והליבה זהות לקוד הקודם)
    function renderTable() {
        courseListEl.innerHTML = '';
        const filteredAndSortedCourses = getFilteredAndSortedCourses();
        if (filteredAndSortedCourses.length === 0) {
            courseListEl.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-400">לא נמצאו קורסים התואמים את החיפוש.</td></tr>`;
            return;
        }
        filteredAndSortedCourses.forEach(course => {
            const row = document.createElement('tr');
            let gradeDisplay;
            if (course.isPassFail) {
                gradeDisplay = `<span class="font-bold text-gray-500 dark:text-gray-400">עבר</span>`;
            } else {
                const gradeColor = course.grade >= 85 ? 'stat-number-success' : 'text-gray-700 dark:text-gray-300';
                gradeDisplay = `<span class="font-bold ${gradeColor}">${course.grade}</span>`;
            }
            row.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-900 dark:text-gray-200">${course.name}</td>
                <td class="px-4 py-3"><span class="badge-category">${course.category}</span></td>
                <td class="px-4 py-3">${course.semester}</td>
                <td class="px-4 py-3">${course.credits}</td>
                <td class="px-4 py-3">${gradeDisplay}</td>
                <td class="px-4 py-3">${course.isMoedB ? '<span class="badge-moed-b">ב׳</span>' : '<span class="badge-moed-a">א׳</span>'}</td>
                <td class="px-4 py-3 text-center">
                    <button class="edit-btn p-1 text-blue-500 hover:text-blue-700 transition-colors" data-id="${course.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                    <button class="delete-btn p-1 text-red-500 hover:text-red-700 transition-colors" data-id="${course.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            courseListEl.appendChild(row);
        });
        lucide.createIcons();
    }

    function calculateAndRenderSummary() {
        const coursesWithGrades = state.courses.filter(c => !c.isPassFail);
        const numCourses = state.courses.length;
        if (numCourses === 0) {
            avgGradeEl.textContent = '0.00';
            totalCreditsEl.textContent = '0';
            highestGradeEl.textContent = '-';
            lowestGradeEl.textContent = '-';
            degreeProgressBar.style.width = '0%';
            degreeProgressText.textContent = '0%';
            return;
        }
        let totalCredits = state.courses.reduce((sum, c) => sum + parseFloat(c.credits), 0);
        let weightedGradeSum = 0;
        let highest = { grade: -1, name: '' };
        let lowest = { grade: 101, name: '' };
        let creditsForAvg = 0;
        coursesWithGrades.forEach(c => {
            const credits = parseFloat(c.credits);
            const grade = parseInt(c.grade);
            weightedGradeSum += grade * credits;
            creditsForAvg += credits;
            if (grade > highest.grade) highest = { grade, name: c.name };
            if (grade < lowest.grade) lowest = { grade, name: c.name };
        });
        const avgGrade = creditsForAvg > 0 ? (weightedGradeSum / creditsForAvg) : 0;
        avgGradeEl.textContent = avgGrade.toFixed(2);
        totalCreditsEl.textContent = totalCredits;
        highestGradeEl.textContent = coursesWithGrades.length > 0 ? `${highest.name} (${highest.grade})` : '-';
        lowestGradeEl.textContent = coursesWithGrades.length > 0 ? `${lowest.name} (${lowest.grade})` : '-';
        const requiredCredits = parseFloat(state.userInfo.requiredCredits) || 1;
        const progress = Math.min(100, (totalCredits / requiredCredits) * 100);
        degreeProgressBar.style.width = `${progress}%`;
        degreeProgressText.textContent = `${progress.toFixed(1)}%`;
        if (progress >= 100) {
            launchConfetti();
        }
    }

    // ===== מחיקה: כל פונקציות הגרפים והסיכומים =====
    // renderAggregatedAverages נמחק
    // renderSemesterAverages נמחק
    // renderCategoryAverages נמחק
    // renderCharts נמחק
    // renderMoedChart נמחק
    // renderTrendChart נמחק
    
    function updateHeader() {
        headerSubtitle.textContent = state.userInfo.name ? `ברוך הבא, ${state.userInfo.name}!` : `ברוך הבא!`;
        if (state.userInfo.major) {
            headerTitle.textContent = `מקצוע: ${state.userInfo.major}`;
        }
    }

    function getFilteredAndSortedCourses() {
        let courses = [...state.courses];
        if (state.viewState.searchTerm) {
            courses = courses.filter(c => c.name.toLowerCase().includes(state.viewState.searchTerm.toLowerCase()));
        }
        if (state.viewState.filterSemester !== 'all') {
            courses = courses.filter(c => c.semester == state.viewState.filterSemester);
        }
        if (state.viewState.filterCategory !== 'all') {
            courses = courses.filter(c => c.category === state.viewState.filterCategory);
        }
        courses.sort((a, b) => {
            const aVal = a[state.viewState.sortBy];
            const bVal = b[state.viewState.sortBy];
            let comparison = 0;
            if (typeof aVal === 'string') {
                comparison = aVal.localeCompare(bVal, 'he');
            } else {
                comparison = (aVal || 0) - (bVal || 0);
            }
            return state.viewState.sortOrder === 'asc' ? comparison : -comparison;
        });
        return courses;
    }

    function populateFilterOptions() {
        const semesters = [...new Set(state.courses.map(c => c.semester))].sort((a,b) => a-b);
        filterSemesterEl.innerHTML = '<option value="all">כל הסמסטרים</option>';
        semesters.forEach(s => {
            const option = new Option(`סמסטר ${s}`, s);
            filterSemesterEl.add(option);
        });
        filterSemesterEl.value = state.viewState.filterSemester;
        filterCategoryEl.innerHTML = '<option value="all">כל הקטגוריות</option>';
        state.userInfo.categories.forEach(c => {
             const option = new Option(c, c);
             filterCategoryEl.add(option);
        });
        filterCategoryEl.value = state.viewState.filterCategory;
    }

    function addWhatIfCourseRow() {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-2 gap-2 what-if-row';
        row.innerHTML = `
            <input type="number" placeholder="ציון (0-100)" class="what-if-grade w-full p-2 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
            <input type="number" step="0.5" placeholder='נ"ז' class="what-if-credits w-full p-2 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:placeholder-gray-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
        `;
        whatIfCoursesContainer.appendChild(row);
    }
    
    function calculateWhatIf() {
        const coursesWithGrades = state.courses.filter(c => !c.isPassFail);
        let currentWeightedSum = coursesWithGrades.reduce((sum, c) => sum + (c.grade * c.credits), 0);
        let currentCreditsForAvg = coursesWithGrades.reduce((sum, c) => sum + c.credits, 0);
        let whatIfWeightedSum = 0;
        let whatIfCredits = 0;
        document.querySelectorAll('.what-if-row').forEach(row => {
            const grade = parseFloat(row.querySelector('.what-if-grade').value);
            const credits = parseFloat(row.querySelector('.what-if-credits').value);
            if (!isNaN(grade) && !isNaN(credits) && grade >= 0 && grade <= 100 && credits > 0) {
                whatIfWeightedSum += grade * credits;
                whatIfCredits += credits;
            }
        });
        const totalWeightedSum = currentWeightedSum + whatIfWeightedSum;
        const totalCreditsForAvg = currentCreditsForAvg + whatIfCredits;
        const newAvg = totalCreditsForAvg > 0 ? (totalWeightedSum / totalCreditsForAvg) : 0;
        whatIfResultEl.textContent = newAvg.toFixed(2);
        whatIfCreditsInfoEl.textContent = `סה"כ ${totalCreditsForAvg} נ"ז בחישוב`;
    }
    
    function resetAndCalculateWhatIf() {
        whatIfCoursesContainer.innerHTML = '';
        addWhatIfCourseRow();
        calculateWhatIf();
    }

    function launchConfetti() {
        confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
    }

    function populateCategoryDropdowns() {
        courseCategoryInput.innerHTML = '';
        state.userInfo.categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            courseCategoryInput.appendChild(option);
        });
    }
    
    function applyDarkMode() {
        // שמירת העדפה ב-localStorage (זה בסדר, זה לא "דאטה")
        localStorage.setItem('theme', state.darkMode ? 'dark' : 'light');
        document.documentElement.classList.toggle('dark', state.darkMode);
    }

    // --- === INITIALIZATION (משוכתב) === ---
    
    /**
     * פונקציית האתחול הראשית.
     * היא נקראת רק *אחרי* שה-DOM נטען ו-Firebase זיהה משתמש מחובר.
     */
    async function initApp() {
        
        // --- תיקון: איתחול משתני DOM ---
        loadingContainer = document.getElementById('loading-container');
        appContainer = document.getElementById('app-container');
        courseForm = document.getElementById('course-form');
        courseListEl = document.getElementById('course-list');
        formTitle = document.getElementById('form-title');
        submitBtn = document.getElementById('submit-btn');
        cancelEditBtn = document.getElementById('cancel-edit-btn');
        courseNameInput = document.getElementById('courseName');
        creditsInput = document.getElementById('credits');
        gradeInput = document.getElementById('grade');
        semesterInput = document.getElementById('semester');
        isMoedBInput = document.getElementById('isMoedB');
        isPassFailInput = document.getElementById('isPassFail');
        courseCategoryInput = document.getElementById('courseCategory');
        avgGradeEl = document.getElementById('avg-grade');
        totalCreditsEl = document.getElementById('total-credits');
        highestGradeEl = document.getElementById('highest-grade');
        lowestGradeEl = document.getElementById('lowest-grade');
        degreeProgressText = document.getElementById('degree-progress-text');
        degreeProgressBar = document.getElementById('degree-progress-bar');
        // ===== מחיקה: semesterAveragesEl, categoryAveragesEl =====
        settingsModal = document.getElementById('settings-modal');
        settingsForm = document.getElementById('settings-form');
        userNameInput = document.getElementById('userName');
        institutionInput = document.getElementById('institution');
        majorInput = document.getElementById('major');
        requiredCreditsInput = document.getElementById('requiredCredits');
        userCategoriesInput = document.getElementById('userCategories');
        headerTitle = document.getElementById('header-title');
        headerSubtitle = document.getElementById('header-subtitle');
        confirmModal = document.getElementById('confirm-modal');
        whatIfModal = document.getElementById('what-if-modal');
        whatIfCoursesContainer = document.getElementById('what-if-courses');
        whatIfResultEl = document.getElementById('what-if-result');
        whatIfCreditsInfoEl = document.getElementById('what-if-credits-info');
        searchInput = document.getElementById('search-input');
        filterSemesterEl = document.getElementById('filter-semester');
        filterCategoryEl = document.getElementById('filter-category');
        csvFileInput = document.getElementById('csv-file-input');
        darkModeToggle = document.getElementById('dark-mode-toggle');
        // ------------------------------------

        // 1. הסתרת טוען והצגת אפליקציה
        loadingContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');

        // 2. טעינת העדפת Dark Mode
        state.darkMode = localStorage.getItem('theme') === 'dark';
        applyDarkMode();

        // 3. טעינת הנתונים מהענן (פעולה אסינכרונית)
        await loadState();

        // 4. אכלוס ה-DOM עם הנתונים שנטענו
        userNameInput.value = state.userInfo.name;
        institutionInput.value = state.userInfo.institution;
        majorInput.value = state.userInfo.major;
        requiredCreditsInput.value = state.userInfo.requiredCredits;
        userCategoriesInput.value = state.userInfo.categories.join(', ');
        
        // 5. אתחול שאר האפליקציה וחיבור האזנות
        populateCategoryDropdowns();
        updateDashboard(); // זה יפעיל את כל פונקציות הרנדור
        lucide.createIcons();

        // --- 6. חיבור האזנות (Listeners) ---
        isPassFailInput.addEventListener('change', (e) => {
            if (e.target.checked) {
                gradeInput.disabled = true;
                gradeInput.value = '';
                gradeInput.style.opacity = '0.5';
            } else {
                gradeInput.disabled = false;
                gradeInput.style.opacity = '1';
            }
        });

        courseForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = courseNameInput.value.trim();
            const credits = parseFloat(creditsInput.value);
            const isPassFail = isPassFailInput.checked;
            const grade = isPassFail ? null : parseInt(gradeInput.value);
            const semester = parseInt(semesterInput.value);
            const isMoedB = isMoedBInput.checked;
            const category = courseCategoryInput.value;
            if (!name || isNaN(credits) || credits < 0 || isNaN(semester) || semester < 1 || (!isPassFail && (isNaN(grade) || grade < 0 || grade > 100))) {
                alert('נא למלא את כל השדות בערכים חוקיים.');
                return;
            }
            const courseData = { name, credits, grade, semester, isMoedB, category, isPassFail };
            if (state.editMode.active) {
                const index = state.courses.findIndex(c => c.id === state.editMode.courseId);
                if (index > -1) {
                    state.courses[index] = { ...state.courses[index], ...courseData };
                }
                exitEditMode();
            } else {
                state.courses.push({ id: Date.now(), ...courseData });
            }
            courseForm.reset();
            gradeInput.disabled = false;
            gradeInput.style.opacity = '1';
            updateDashboard(); 
        });

        courseListEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = parseInt(target.dataset.id);
            if (target.classList.contains('delete-btn')) {
                state.courses = state.courses.filter(c => c.id !== id);
                if (state.editMode.active && state.editMode.courseId === id) {
                    exitEditMode();
                }
                updateDashboard(); 
            } else if (target.classList.contains('edit-btn')) {
                enterEditMode(id);
            }
        });

        function enterEditMode(id) {
            const course = state.courses.find(c => c.id === id);
            if (!course) return;
            state.editMode = { active: true, courseId: id };
            courseNameInput.value = course.name;
            creditsInput.value = course.credits;
            isPassFailInput.checked = course.isPassFail;
            gradeInput.value = course.isPassFail ? '' : course.grade;
            gradeInput.disabled = course.isPassFail;
            gradeInput.style.opacity = course.isPassFail ? '0.5' : '1';
            semesterInput.value = course.semester;
            isMoedBInput.checked = course.isMoedB;
            courseCategoryInput.value = course.category;
            formTitle.textContent = 'עריכת קורס';
            submitBtn.textContent = 'שמור שינויים';
            cancelEditBtn.classList.remove('hidden');
            formContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function exitEditMode() {
            state.editMode = { active: false, courseId: null };
            formTitle.textContent = 'הוספת קורס חדש';
            submitBtn.textContent = 'הוסף קורס';
            cancelEditBtn.classList.add('hidden');
            courseForm.reset();
            gradeInput.disabled = false;
            gradeInput.style.opacity = '1';
        }

        cancelEditBtn.addEventListener('click', exitEditMode);
        
        // Modal Handlers
        document.getElementById('settings-btn').addEventListener('click', () => settingsModal.classList.remove('hidden'));
        document.getElementById('close-settings-btn').addEventListener('click', () => settingsModal.classList.add('hidden'));
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.classList.add('hidden');
        });

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            state.userInfo = {
                name: userNameInput.value.trim(),
                institution: institutionInput.value.trim(),
                major: majorInput.value.trim(),
                requiredCredits: parseFloat(requiredCreditsInput.value) || 120,
                categories: userCategoriesInput.value.split(',').map(c => c.trim()).filter(Boolean)
            };
            settingsModal.classList.add('hidden');
            populateCategoryDropdowns();
            updateDashboard(); 
        });
        
        document.getElementById('clear-data-btn').addEventListener('click', () => confirmModal.classList.remove('hidden'));
        document.getElementById('cancel-delete-btn').addEventListener('click', () => confirmModal.classList.add('hidden'));
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) confirmModal.classList.add('hidden');
        });
        
        document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
            state.courses = [];
            state.userInfo = { name: '', institution: '', major: '', requiredCredits: 120, categories: ['חובה', 'בחירה', 'כללי', 'ספורט'] };
            state.viewState = { searchTerm: '', filterSemester: 'all', filterCategory: 'all', sortBy: 'semester', 'sortOrder': 'asc' };

            if (academicDataRef) {
                try {
                    await academicDataRef.delete();
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("שגיאה במחיקת הנתונים מהענן.");
                }
            }
            confirmModal.classList.add('hidden');
            settingsModal.classList.add('hidden');
            exitEditMode();
            userNameInput.value = '';
            institutionInput.value = '';
            majorInput.value = '';
            requiredCreditsInput.value = state.userInfo.requiredCredits;
            userCategoriesInput.value = state.userInfo.categories.join(', ');
            updateDashboard(); 
        });

        // What-If Modal
        document.getElementById('what-if-btn').addEventListener('click', () => {
            whatIfModal.classList.remove('hidden');
            resetAndCalculateWhatIf();
        });
        document.getElementById('close-what-if-btn').addEventListener('click', () => whatIfModal.classList.add('hidden'));
        whatIfModal.addEventListener('click', e => {
            if (e.target === whatIfModal) whatIfModal.classList.add('hidden');
        });
        document.getElementById('add-what-if-course-btn').addEventListener('click', addWhatIfCourseRow);
        whatIfCoursesContainer.addEventListener('input', calculateWhatIf);

        // Dark Mode
        darkModeToggle.addEventListener('click', () => {
            state.darkMode = !state.darkMode;
            applyDarkMode();
            // ===== מחיקה: renderCharts(); =====
        });

        // CSV Import / Export Logic
        document.getElementById('import-csv-btn').addEventListener('click', () => {
            csvFileInput.click();
        });
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '').slice(1);
                    const newCourses = [];
                    lines.forEach((line, index) => {
                        const columns = line.split(',');
                        if (columns.length < 7) return; 
                        const name = columns[0].trim().replace(/"/g, '');
                        const category = columns[1].trim();
                        const credits = parseFloat(columns[2]);
                        const gradeStr = columns[3].trim();
                        const semester = parseInt(columns[4]);
                        const isMoedB = columns[5].trim() === 'כן';
                        const isPassFail = columns[6].trim() === 'כן';
                        const grade = isPassFail ? null : parseInt(gradeStr);
                        if (name && category && !isNaN(credits) && !isNaN(semester)) {
                             newCourses.push({
                                id: Date.now() + index,
                                name, category, credits, grade, semester, isMoedB, isPassFail
                            });
                        }
                    });
                    if (confirm(`האם אתה בטוח שברצונך להחליף את כל הנתונים הקיימים ב-${newCourses.length} קורסים מהקובץ?`)) {
                        state.courses = newCourses;
                        updateDashboard(); // <-- זה ישמור אוטומטית ב-Firestore
                        alert(`ייבוא הושלם בהצלחה!`);
                    }
                } catch (error) {
                    console.error("Error parsing CSV:", error);
                    alert("שגיאה בייבוא הקובץ. אנא ודא שהקובץ תקין ובפורמט הנכון.");
                } finally {
                    csvFileInput.value = ''; 
                }
            };
            reader.readAsText(file, 'UTF-8');
        });
        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if (state.courses.length === 0) {
                alert('אין נתונים לייצוא.');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "שם הקורס,קטגוריה,נקודות זכות,ציון,סמסטר,מועד ב',בינארי\r\n";
            const sortedCourses = getFilteredAndSortedCourses();
            sortedCourses.forEach(course => {
                const row = [
                    `"${course.name.replace(/"/g, '""')}"`,
                    course.category,
                    course.credits,
                    course.isPassFail ? "" : course.grade,
                    course.semester,
                    course.isMoedB ? 'כן' : 'לא',
                    course.isPassFail ? 'כן' : 'לא'
                ].join(',');
                csvContent += row + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `academic_grades_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Filtering and Sorting
        searchInput.addEventListener('input', (e) => {
            state.viewState.searchTerm = e.target.value;
            renderTable();
        });
        filterSemesterEl.addEventListener('change', (e) => {
            state.viewState.filterSemester = e.target.value;
            renderTable();
        });
        filterCategoryEl.addEventListener('change', (e) => {
            state.viewState.filterCategory = e.target.value;
            renderTable();
        });
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                if (state.viewState.sortBy === sortBy) {
                    state.viewState.sortOrder = state.viewState.sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    state.viewState.sortBy = sortBy;
                    state.viewState.sortOrder = 'asc';
                }
                renderTable();
            });
        });
    }
    
    </script>
</body>
</html>


