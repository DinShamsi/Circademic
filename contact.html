<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circademic - צור קשר</title>
    <link rel="icon" href="favicon2.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&family=Rubik:wght@600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@0.395.0/dist/umd/lucide.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        /* Design System Variables */
        :root {
            --primary: #3B82F6; --primary-light: #60A5FA; --primary-dark: #2563EB;
            --secondary: #8B5CF6; --secondary-light: #A78BFA; --secondary-dark: #7C3AED;
            --accent: #F59E0B; --accent-light: #FBBF24; --accent-dark: #D97706;
            --bg-light: #F9FAFB; --bg-dark: #0F172A; --bg-dark-card: #1E293B;
            --border-light: #E5E7EB; --border-dark: #374151;
            --radius-lg: 16px; --radius-md: 12px;
        }

        body { 
            font-family: 'Heebo', sans-serif;
            background: var(--bg-light);
            transition: background-color 0.3s ease;
        }
        body.dark { background: var(--bg-dark); }
        h1, h2, h3 { font-family: 'Rubik', sans-serif; font-weight: 700; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Components */
        .sidebar { background: white; box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05); transition: transform 0.3s ease; z-index: 40; }
        .dark .sidebar { background: var(--bg-dark-card); box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); }
        @media (max-width: 768px) { .sidebar { position: fixed; top: 0; right: -100%; height: 100vh; width: 280px; } .sidebar.open { right: 0; } }
        
        .dashboard-card { background: white; border-radius: var(--radius-lg); padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 1px solid rgba(59, 130, 246, 0.1); animation: fadeInUp 0.5s ease-out; }
        .dark .dashboard-card { background: var(--bg-dark-card); border-color: rgba(59, 130, 246, 0.2); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3); }

        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 12px; color: #6B7280; text-decoration: none; transition: all 0.2s ease; cursor: pointer; }
        .nav-item:hover { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .nav-item.active { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); color: var(--primary); font-weight: 600; }
        .dark .nav-item { color: #9CA3AF; }
        .dark .nav-item:hover { background: rgba(59, 130, 246, 0.2); color: var(--primary-light); }
        
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease; width: 100%; display: flex; justify-content: center; align-items: center; gap: 0.5rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(59, 130, 246, 0.5); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .input-field, select, textarea { padding: 0.75rem 1rem; border: 2px solid var(--border-light); border-radius: 12px; background: var(--bg-light); width: 100%; transition: all 0.2s; }
        .input-field:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .dark .input-field, .dark select, .dark textarea { background: #030712; border-color: var(--border-dark); color: white; }
        .dark .input-field:focus, .dark select:focus, .dark textarea:focus { background: var(--bg-dark); border-color: var(--primary-light); }

        .loading { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; background: var(--bg-light); z-index: 100; }
        .dark .loading { background: var(--bg-dark); }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        
        .loading-spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }

        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge.new { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    
    <div id="loading-screen" class="loading"><div class="spinner"></div></div>

    <div id="app" class="hidden">
        
        <button id="mobile-menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg">
            <i data-lucide="menu" class="w-5 h-5 text-gray-700 dark:text-gray-300"></i>
        </button>
        <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

        <div class="flex min-h-screen">
            
            <aside id="sidebar" class="sidebar w-64 flex-shrink-0 md:relative md:translate-x-0">
                <div class="p-6 h-full flex flex-col">
                    <div class="mb-8">
                        <div class="flex items-center gap-3 mb-6">
                            <img src="LOGO.png" alt="Logo" class="w-12 h-12">
                            <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">Circademic</h1>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-700 rounded-xl p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="user-avatar" id="user-avatar">
                                    <i data-lucide="user" class="w-5 h-5"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <p class="font-semibold text-gray-800 dark:text-gray-200 truncate" id="user-name">טוען...</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 truncate" id="user-email">...</p>
                                </div>
                            </div>
                            
                            <div id="guest-actions" class="hidden">
                                <a href="login.html" class="block w-full text-center bg-blue-600 text-white text-sm py-2 rounded-lg font-bold hover:bg-blue-700 transition">התחבר למערכת</a>
                            </div>

                            <div id="user-actions" class="hidden gap-2">
                                <button id="profile-settings" class="text-xs px-3 py-1 bg-white dark:bg-gray-700 rounded-lg hover:shadow-md transition-all w-full text-center">הגדרות</button>
                                <button id="logout-btn" class="text-xs px-3 py-1 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 rounded-lg hover:shadow-md transition-all w-full text-center">יציאה</button>
                            </div>
                        </div>
                    </div>

                    <nav class="flex-1 space-y-1">
                        <a href="index.html" class="nav-item"><i data-lucide="home" class="w-5 h-5"></i><span>לוח בקרה</span></a>
                        <a href="AcademicStatus.html" class="nav-item"><i data-lucide="graduation-cap" class="w-5 h-5"></i><span>מעקב אקדמי</span></a>
                        <a href="blog.html" class="nav-item"><i data-lucide="book-open" class="w-5 h-5"></i><span>בלוג ועדכונים</span></a>
                        <a href="#" onclick="alert('בקרוב!')" class="nav-item"><i data-lucide="calendar" class="w-5 h-5"></i><span>מערכת שעות</span><span class="badge new mr-auto">בקרוב</span></a>
                        <a href="#" onclick="alert('בקרוב!')" class="nav-item"><i data-lucide="file-text" class="w-5 h-5"></i><span>סיכומים</span><span class="badge new mr-auto">בקרוב</span></a>
                        
                        <hr class="my-4 border-gray-200 dark:border-gray-700">
                        
                        <a href="contact.html" class="nav-item active"><i data-lucide="send" class="w-5 h-5"></i><span>צור קשר</span></a>
                        <a href="about.html" class="nav-item"><i data-lucide="info" class="w-5 h-5"></i><span>אודות המערכת</span></a>
                    </nav>

                    <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
                        <button id="dark-mode-toggle" class="nav-item w-full">
                            <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                            <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                            <span>מצב כהה</span>
                        </button>
                    </div>
                </div>
            </aside>

            <main class="flex-1 p-4 md:p-8 overflow-y-auto h-screen">
                
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-2">
                        צור קשר
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">
                        יש לך שאלה? הצעה לשיפור? או סתם רוצה להגיד שלום? נשמח לשמוע ממך!
                    </p>
                </header>

                <div class="dashboard-card max-w-2xl mx-auto">
                    <form id="contact-form" class="space-y-6">
                        
                        <div id="message-container"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="contact-name" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">שם מלא</label>
                                <input type="text" id="contact-name" class="input-field" required>
                            </div>
                            <div>
                                <label for="contact-email" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">כתובת אימייל</label>
                                <input type="email" id="contact-email" class="input-field" required>
                            </div>
                        </div>

                        <div>
                            <label for="contact-subject" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">נושא הפנייה</label>
                            <select id="contact-subject" class="input-field" required>
                                <option value="" disabled selected>בחר נושא...</option>
                                <option value="דיווח על תקלה">דיווח על תקלה</option>
                                <option value="הצעה לפיצ'ר">הצעה לפיצ'ר</option>
                                <option value="שאלה כללית">שאלה כללית</option>
                                <option value="אחר">אחר</option>
                            </select>
                        </div>

                        <div>
                            <label for="contact-message" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ההודעה שלך</label>
                            <textarea id="contact-message" rows="6" class="input-field" placeholder="כתוב כאן את הודעתך..." required></textarea>
                        </div>

                        <div>
                            <button type="submit" id="submit-btn" class="btn-primary w-full md:w-auto">
                                <span id="submit-btn-text">שלח הודעה</span>
                                <span id="submit-spinner" class="loading-spinner hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-md w-full" style="animation: fadeInUp 0.3s ease-out;">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6">הגדרות פרופיל</h2>
            <form id="settings-form" class="space-y-4">
                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">שם מלא</label><input type="text" id="settings-name" class="input-field"></div>
                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">מוסד לימודים</label><input type="text" id="settings-institution" class="input-field"></div>
                <div><label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">תחום לימוד</label><input type="text" id="settings-major" class="input-field"></div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="btn-primary flex-1">שמור שינויים</button>
                    <button type="button" id="close-settings" class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDj1V85FXrcZ8Tg1kezkTsO50bgMOLcnPk",
            authDomain: "circademic-582dc.firebaseapp.com",
            projectId: "circademic-582dc",
            storageBucket: "circademic-582dc.firebasestorage.app",
            messagingSenderId: "296566462689",
            appId: "1:296566462689:web:d23a6f74078de2332bbfa0",
            measurementId: "G-SPD143KGDK"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const app = document.getElementById('app');
        const userNameEl = document.getElementById('user-name');
        const userEmailEl = document.getElementById('user-email');
        const userAvatarEl = document.getElementById('user-avatar');
        const guestActions = document.getElementById('guest-actions');
        const userActions = document.getElementById('user-actions');
        const contactForm = document.getElementById('contact-form');
        const submitBtn = document.getElementById('submit-btn');
        const messageContainer = document.getElementById('message-container');
        const settingsModal = document.getElementById('settings-modal');

        // Auth State
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // --- USER MODE ---
                currentUser = user;
                
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if(doc.exists) userData = doc.data();
                } catch (e) { console.warn(e); }

                // Update Sidebar
                if(userNameEl) userNameEl.textContent = user.displayName || 'משתמש';
                if(userEmailEl) userEmailEl.textContent = user.email;
                if(userAvatarEl) {
                    userAvatarEl.textContent = (user.displayName || 'U').charAt(0).toUpperCase();
                    userAvatarEl.innerHTML = (user.displayName || 'U').charAt(0).toUpperCase();
                }

                // Pre-fill Form
                document.getElementById('contact-name').value = userData?.name || user.displayName || '';
                document.getElementById('contact-email').value = userData?.email || user.email || '';

                if(guestActions) guestActions.classList.add('hidden');
                if(userActions) {
                    userActions.classList.remove('hidden');
                    userActions.classList.add('flex');
                }

            } else {
                // --- GUEST MODE ---
                currentUser = null;
                userData = null;

                if(userNameEl) userNameEl.textContent = 'שלום אורח';
                if(userEmailEl) userEmailEl.textContent = 'התחבר כדי לשמור נתונים';
                if(userAvatarEl) userAvatarEl.innerHTML = '<i data-lucide="user" class="w-5 h-5"></i>';

                if(userActions) userActions.classList.add('hidden');
                if(guestActions) guestActions.classList.remove('hidden');
            }

            loadingScreen.classList.add('hidden');
            app.classList.remove('hidden');
            lucide.createIcons();
        });

        // Form Submit Logic
        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);
            messageContainer.innerHTML = '';

            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const subject = document.getElementById('contact-subject').value;
            const message = document.getElementById('contact-message').value;

            try {
                await db.collection('contactSubmissions').add({
                    name,
                    email,
                    subject,
                    message,
                    userId: currentUser ? currentUser.uid : 'guest', // Handle guest ID
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'new'
                });
                
                showMessage('הודעתך נשלחה בהצלחה! ניצור איתך קשר בהקדם.', 'success');
                contactForm.reset();
                
                // Re-fill for logged in users
                if (currentUser) {
                    document.getElementById('contact-name').value = userData?.name || currentUser.displayName || '';
                    document.getElementById('contact-email').value = userData?.email || currentUser.email || '';
                }

            } catch (error) {
                console.error("Error:", error);
                showMessage('אירעה שגיאה בשליחה. וודא שיש לך חיבור לאינטרנט.', 'error');
            } finally {
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            const text = document.getElementById('submit-btn-text');
            const spinner = document.getElementById('submit-spinner');
            submitBtn.disabled = isLoading;
            if(isLoading) { text.style.display = 'none'; spinner.classList.remove('hidden'); }
            else { text.style.display = 'block'; spinner.classList.add('hidden'); }
        }

        function showMessage(msg, type) {
            const color = type === 'error' ? 'red' : 'green';
            messageContainer.innerHTML = `
                <div class="bg-${color}-100 dark:bg-${color}-900 border border-${color}-400 text-${color}-700 dark:text-${color}-200 px-4 py-3 rounded relative mb-4" role="alert">
                    <span class="block sm:inline">${msg}</span>
                </div>`;
        }

        // UI Interactions
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        document.getElementById('mobile-menu-toggle').addEventListener('click', () => { sidebar.classList.add('open'); mobileOverlay.classList.remove('hidden'); });
        mobileOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); mobileOverlay.classList.add('hidden'); });

        const darkModeToggle = document.getElementById('dark-mode-toggle');
        if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        darkModeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            lucide.createIcons();
        });

        document.getElementById('profile-settings').addEventListener('click', () => {
            if(!currentUser) return;
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
            document.getElementById('settings-name').value = userData?.name || currentUser.displayName || '';
            document.getElementById('settings-institution').value = userData?.institution || '';
            document.getElementById('settings-major').value = userData?.major || '';
        });

        document.getElementById('close-settings').addEventListener('click', () => settingsModal.classList.add('hidden'));

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) return;
            const name = document.getElementById('settings-name').value;
            const institution = document.getElementById('settings-institution').value;
            const major = document.getElementById('settings-major').value;
            try {
                await db.collection('users').doc(currentUser.uid).set({ name, institution, major }, { merge: true });
                if(name) await currentUser.updateProfile({ displayName: name });
                userData = { ...userData, name, institution, major };
                userNameEl.textContent = name;
                settingsModal.classList.add('hidden');
                alert('ההגדרות נשמרו!');
            } catch(e) { alert('שגיאה בשמירה'); }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if(confirm('לצאת מהמערכת?')) {
                await auth.signOut();
                window.location.href = 'login.html';
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>
